---
title: ''
author: "Jennifer Salazar"
date: "17/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
Introducción
---
Resumen

---
Retos

---
Contextualización

---
### Análisis descriptivo 

* Lectura de la base de datos

```{r}
df <- read.csv("base_trabajo_segmentacion.csv", sep = ";", dec = '.', header = T)
df <- df[, -1]
head(df)
```



```{r}
dim(df)
```

* El conjunto de datos cuenta con 2233 registros es decir 2233 empresas que son clientes de la compañia a realizar el estudio.

* El conjunto de datos cuenta con 46 variables, de las cuales, la primera es el identificador (nit) de cada empresa (cliente), las siguientes 30, hacen referencia al uso de los clientes de los diferentes canales con los que dispone la organización, estos se dividen en canales de entrada y de salida y además unos miden los montos de dinero que manejan y otras el número de transacciones que pasan a traves de estos. Las 16 variables restantes tienen que ver con caracteristicas financieras, las cuales permiten conocer algunas peculiaridades de como esta estructurada la empresa(cliente).




* Separación de las variables financieras y canales (no escaladas)

```{r}
finan_no_scaled <- df[, 31:46]
Canal_no_scaled <- df[ , 1:30]
```


* Separando en conjunto de datos de canales y financiera donde ya estan escaladas:


```{r}
# Escalamiento de los datos completos
df_scaled <- scale(df, center = T, scale = T)

Canal_scaled <- df_scaled[,1:30]
finan_scaled <- df_scaled[,31:46]
```


* Variables de los canales en logaritmo sin escalar y escalando

```{r}
Canal_log <- log(Canal_no_scaled + 1) 

Canal_log_scaled <- scale(log(Canal_no_scaled + 1), center = T, scale = T)
```



Análisis descriptivo de las variables de los montos en los canales de entrada y salida:

En millones de pesos

```{r}
summary(Canal_no_scaled[c(1:11, 23:26)]/1000000)
```

Análisis descriptivo de las variables de número de transacciones por canal de entrada y salida:

En número de transacciones

```{r}
summary(Canal_no_scaled[c(12:22, 27:30)])
```


- Dado que se cuenta con unas cifras numericas muy grandes, se decide realizar el análisis gráfico de estas variables mediante el logaritmo, ya que este permite una mejor visualización y compresión de cuales canales tienen mayor uso, cual manejan mayor dinero y cuales mayor número de transacciones y asi comprender mejor el funcionamiento de los distintos canales.

* Gráfico de la media del logaritmo de cada variable asociadas a los canales


```{r}
fila_porcentaje <- function(fila){
  
  fila_suma <- sum(fila)
  
  if(fila_suma != 0){
    
    return(fila/fila_suma)
  }else{
   
    return(fila)
  }
}


Canal_porcentaje <- Canal_no_scaled


Canal_porcentaje[, 1:11] <- t(apply(Canal_no_scaled[, 1:11], 1, fila_porcentaje))

Canal_porcentaje[, 12:22] <- t(apply(Canal_no_scaled[, 12:22], 1, fila_porcentaje))

Canal_porcentaje[, 23:26] <- t(apply(Canal_no_scaled[, 23:26], 1, fila_porcentaje))

Canal_porcentaje[, 27:30] <- t(apply(Canal_no_scaled[, 27:30], 1, fila_porcentaje))

```


```{r}
#layout(rbind(c(1,1,1),c(2,2,2)))
par(mfcol = c(2, 1), mar = numeric(4), oma = c(4, 4, .5, .5), 
   mgp = c(2, .6, 0))
plot(1:30, colMeans(Canal_log), type = 'b', xaxt = "n", xlab = '', 
     lwd = 2, ylab = 'Media', col="cyan4")
#axis(1, 1:30, names(df)[1:30], las = 2)
grid()

plot(1:30, colMeans(Canal_porcentaje), type = 'b', col = 'cyan4', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'Media')
axis(1, 1:30, names(df)[1:30], las = 2)
grid()
mtext("Media", side = 2, outer = TRUE, line = 1.7, adj = 0.75)
mtext("Porcentaje", side = 2, outer = F, line = 1.7)
```


```{r}
layout(rbind(c(1,1,2,2),c(3,3,4,4)))
boxplot(log(df[,1:11]+1), las=2, col="cyan4")
boxplot(log(df[,12:22]+1), las=2, col="cyan4")
boxplot(log(df[,23:26]+1), las=2, col="cyan4")
boxplot(log(df[,27:30]+1), las=2, col="cyan4")
```





#### Mediante el gráfico se puede analizar que:

_Análisis de los canales de entrada:_

* los canales de entrada que manejan un monto promedio más alto de dinero son: canal1, canal2, canal6, canal8 y canal9


* los canales de entrada que manejan un monto promedio más bajo de dinero son: canal4, canal7, canal10 y canalOtros

* los canales de entrada que manejan en promedio un mayor número de transacciones son: canal1 y canal2

* los canales de entrada que manejan en promedio un número intermedio de transacciones son: canal3, canal4, canal5, canal6, canal8 y canal9

* los canales de entrada que manejan en promedio un menor número de transacciones son: canal7, canal10 y CanalOtros.

En general en los canales de entrada, el canal1 y el canal2 son los que manejan un mayor monto promedio de dinero y además un mayor número de transacciones; por otro lado el canal7 y el canal10 son los que manejan menor monto promedio de dinero y además y un menor número de transacciones. También se puede visualizar particularmente que a pesar de que el canal5 maneja un mayor monto promedio de dinero que el canal4, en el canal5 se presenta un menor número de transacciones que en el canal4.



_Análisis de los canales de salida:_

* El canal de salida que maneja un monto promedio mayor de dinero es el canal2

* El canal de salida que maneja un monto promedio intermedio de dinero es el canal5

* Los canales de salida que manejan un monto promedio menor de dinero son el canal8 y canalOtros

* El canal de salida que maneja en promedio un mayor número de transacciones es el canal2.

* Los canales de salida que manejan en promedio un menor número de transacciones son el canal5, canal8 y CanalOtros, aunque entre estos el canal5 es el que realiza un mayor número de transacciones.

En general en los canales de salida, el canal2 es el que maneja un mayor monto promedio de dinero, además un mayor número de transacciones; por otro lado los canales8 y canalOtros son los que manejan los menores montos promedios de dinero y menores números de transacciones.


* Matriz de correlació asociada a las variables de los canales:

```{r, message=FALSE, warning=FALSE}
library(corrplot)
corrplot(cor(Canal_no_scaled), 
         method="color",  
         type="upper", order='original', 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         sig.level = 0.01, insig = "blank", 
         number.cex = 0.5,
         # hide correlation coefficient on the principal diagonal
         diag=FALSE
         )
```

(Pegar esa matriz como img)
(Interpretar)



Las variables asociadas a los canales más correlacionadas son:


```{r, message=FALSE, warning=FALSE}
library(corrr)
library(dplyr)
corr_canales <- Canal_no_scaled %>%
    correlate() %>% 
    stretch() %>% 
    arrange(r)

corr_altas <- corr_canales[which(corr_canales$r > 0.9), ]

nombres <- c(corr_altas$x, corr_altas$y)
unique(nombres)
```


<hr>

Análisis descriptivo de las variables financieras:


```{r, message=FALSE, warning=FALSE}
library(ggplot2)
for(i in 1:dim(finan_no_scaled)[2]){
  
  if(class(finan_no_scaled[, i])=="integer"){
    p <- ggplot(finan_no_scaled, aes(x = finan_no_scaled[, i], y = ..prop..))+ geom_bar(fill = "#0c4c8a")
  }else{
    p <- ggplot(finan_no_scaled, aes(x=finan_no_scaled[, i])) +  geom_histogram(bins = 10, fill = "#0c4c8a")
  }
  
  p_final <- p +
    labs(x = colnames(finan_no_scaled)[i]) +
    theme_gray() 
    
  
  print(p_final)
}
```

- **impo_cv: ** Más del 60% de los clientes tiene un nivel de importación entre 1 y 2.

- **expo_vt: ** Más del 50% de los clientes tiene un nivel del exportación de 2.

- **cxp: ** Más del 50% de los clientes tiene un número bajo de cuentas por cobrar (1 y 2). También destaca que más del 15% de los clientes están en el nivel más alto de cuentas por cobrar (6).

- **cxp: ** Más del 25% de los clientes se encuentran en el nivel más alto del número de cuentas por cobra (6), sin embargo más del 55% de los clientes se encuentra en el nivel 1, 2 y 3 de cuentas por cobrar.
 
- **totalinventory: ** Casi un 25% de los clientes está en el nivel más alto del valor de inventario al 31 de diciembre, El grueso de los clientes se encuntra en el nivel 1, 2 y 3.

_ **pagos_pj: ** 

  * El 75% de los clientes tiene un porcentaje de pago a personas jurídicas que ronda entre el 31.6 y el 77.4 porciento. 
  
  * También se puede observar que en promedio el porcentaje de pago a personas jurídicas está en el 53.9%.
  
  * Aproximadamente un 25% de los clientes del la empresa, tiene un porcentaje de pago a personas jurídicas que ronda entre el 78 y el 100 porciento.
  
- **pagos_pn: **

  * El 75% de los clientes tiene un porcentaje de pago a personas naturales que ronda entre el 20 y el 66.5 porciento. 
  
  * También se puede observar que en promedio el porcentaje de pago a personas naturales está en el 44%.
  
  * Aproximadamente un 25% de los clientes del la empresa, tiene un porcentaje de pago a personas naturales que ronda entre el 0 y el 19 porciento.

- **tiene_ventas_fisicas: ** El 52.4% de los clientes no tiene ventas fisicas, mientras que el 47.5% si.

- **tiene_ventas_electronicas: ** Aproximadamente el 95% de los clientes no tiene ventas electronicas.

- **recaudos_pj: ** El 93.2% de los clientes de la empresa no tienen ingresos provenientes de personas jurídicas. Aproximadamente el 0.8% de los clientes tienen todos sus igresos de personas jurídicas.

- **recaudos_pn: ** El 92.1% de los clientes de la empresa no tiene ingresos provenientes de personas neturales. Aproximadamente el 2% de los clientes tienen todos sus igresos de personas naturales.

- **rotacion_inventarios: ** Un poco más del 20% de los clientes se encuentra en el nivel de rotación más lento de inventario en días (nivel 6). Aproximadamente el 48% de los clientes se encuentra en el nivel de rotación más rápido (nivel 1 y 2).

- **rotacion_cxc: ** Aproximadamente el 55% de los clientes tiene una velocidad alta (nivel 1 y 2) para cobrar sus cuentas.

- **rotacion_cxp: ** Aproximadamente el 65% de los clientes tiene una velocidad alta (nivel 1 y 2) para pagar sus cuentas.

- **cliclo_negocio: ** El 45% de los clientes tiene un ciclo de negocio lento, es decir en los niveles más altos (5 y 6). Aproximadamente el 23% de los clientes tiene un ciclo de negocio nivel 4, es medir medio-lento.

- **cliclo_financiero: ** El 45% de los clientes tiene un ciclo de financiero lento, es decir en los niveles más altos (5 y 6).



* A continuación se pueden observar las características financieras de un cliente promedio.

```{r}
plot(1:16, colMeans(finan_no_scaled), type = 'b', col = 'cyan4', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'Media', ylim = c(0, 4.3))
axis(1, 1:16, names(df)[31:46], las = 2)
text(apply(finan_no_scaled, 2, mean)+0.2, labels = round(apply(finan_no_scaled, 2, mean), 1))
grid()
```


* Matriz de correlaciones


Correlaciones entre las variables financieras

```{r, message=FALSE, warning=FALSE}
library(corrplot)
corrplot(cor(finan_no_scaled), 
         method="color",  
         type="upper", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         sig.level = 0.01, insig = "blank", 
         number.cex = 0.6,
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
         )

```

- Se observa una relación inversamente proporcional entre las variables pagos_pj y pagos_pn, con una correlación de 0.88.

- Se observa una buena relación lineal entre las variables rotacion_inventarios y ciclo_negocio, con un coeficiente de correlación de 0.77.

- Se observa una relación positiva buena entre ciclo_negocio y ciclo_financiero, con un coeficiente de correlación del 0.77.

- Se observa una relación moderada entre rotacion_inventarios y ciclo_financiero, con una correlación de 0.65

- Se observa una relación moderada entre ciclo_negocio y rotacion_cxc, con una correlación de 0.59

- Se observa una relación positiva grande entre impo_cv y expo_vt, con una correlación de 0.87

- Se observa una relación positiva moderada entre totalinventory y cxp, con una correlación de 0.58.

- Se observa una relación positiva moderada entre totalinventory y cxc, con una correlación de 0.52

- Se observa una relación positiva moderada entre cxp y cxc, con una correlación de 0.68.

---
PREPROCESAMIENTO


---
Metodo 1 - (fina - canal - log - scaled)


---

Metodo 2 - (canal - fina - log - scaled)


---
Metodo 3 - (Resumido - log )


---

Caracterización del mejor

---

Conclusiones

---

Que se puede mejorar

---

Referencias


