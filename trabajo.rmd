---
title: "Lectura de los datos"
author: "Miguel Ángel Londoño Ciceros"
date: "19/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Lectura de los datos


```{r}

df <- read.csv("base_trabajo_segmentacion.csv", sep = ";", dec = '.', header = T)

head(df)

```

```{r}
str(df)
```
```{r}
summary(df)
```

```{r}
plot(df[2:11])
```
```{r}
for (i in 1:46){
  boxplot(df[, i], main = paste("Hist de ", names(df)[i]))
}

```

```{r}
df <- df[, -1]
```

```{r}
df_scaled <- scale(df, center = T, scale = T)
```


# Reducción de la dimensionalidad

```{r}
library("FactoMineR")
```

## PCA

```{r}
comp_prin <- PCA(df_scaled, ncp = 3, scale.unit = T)
```
```{r}
(pca_df <- comp_prin$eig)
```

```{r}
plot(1:46, pca_df[, 3])
```


```{r}
comp_prin$var
```


```{r}
require(factoextra)

fviz_screeplot(comp_prin, addlabels = TRUE, ylim = c(0, 20))
```
```{r}
fviz_contrib(comp_prin, choice = "var", axes = 1, top = 10)
```
```{r}
fviz_contrib(comp_prin, choice = "var", axes = 2, top = 10)
```


```{r}
require(plot3D)


plot3D::points3D(comp_prin$ind$coord[, 1], 
                 comp_prin$ind$coord[, 2], 
                 comp_prin$ind$coord[, 3])

require(plotly)

a <- as.data.frame(comp_prin$ind$coord)

plot_ly(data = a,
        x=~Dim.1, 
        y=~Dim.2,
        z=~Dim.3)

```




```{r}
res.hcpc <- HCPC(comp_prin, graph = FALSE)



fviz_dend(res.hcpc, 
          cex = 0.7,                     # Label size
          palette = "jco",               # Color palette see ?ggpubr::ggpar
          rect = TRUE, rect_fill = TRUE, # Add rectangle around groups
          rect_border = "jco",           # Rectangle color
          labels_track_height = 0.8      # Augment the room for labels
)
```










```{r}
fviz_cluster(res.hcpc,
             repel = TRUE,            # Avoid label overlapping
             show.clust.cent = TRUE, # Show cluster centers
             palette = "jco",         # Color palette see ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
             )
```

# MFA

```{r}
str(df)
```

```{r}
datos_mfa <-as.data.frame(df_scaled)


datos_mfa[, 31:35] <- apply(df[, 31:35], 2, as.factor) 

datos_mfa[, 38:39] <- apply(df[, 38:39], 2, as.factor) 

datos_mfa[, 42:46] <- apply(df[, 42:46], 2, as.factor)

```

```{r}
levels(datos_mfa$impo_cv)
```


```{r}
str(datos_mfa)
```


```{r}
res.mfa <- MFA(datos_mfa, 
               group = c(11, 11, 4, 4, 5, 2, 2, 2, 5),
               type = c('s', 's', 's', 's', 'n', 's', 'n', 's', 'n'),
               name.group = c('en_vm', 'en_tx', 'sal_vm', 'sal_tx', 'cat1', 'pagos', 'ventas', 'recaudos', 'rotacion_ciclo'), graph = T)
```

```{r}
res.mfa$eig
```




# Intentando escalar de otra forma

## Eliminando los outliers



```{r}

robust_scaler <- function(columna){
  
  # value = (value – median) / (p75 – p25)
  
  denominador <- IQR(columna) + 0.000000001
  
  col_scaled <- columna - median(columna)
  
  col_scaled <- col_scaled/denominador
  
  return(col_scaled)
}


df_robscale <- apply(df, 2, robust_scaler)

```


```{r}
FactoMineR::PCA(df_robscale[-outliers, ], ncp = 3, graph = T)
```

# Kmeans 

```{r}

require(cluster)

kc <- kmeans(df_robscale[-outliers, ], 3 , nstart = 5, iter.max = 100)

clusplot(df_robscale[-outliers, ], kc$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.p = kc$cluster )
```

```{r}
which(df[, 1] > quantile(df[, 1], 0.95))
```


```{r}
matrix_dist <- dist(df_robscale, upper = TRUE)

distancias <- as.matrix(matrix_dist)[1, ]

dim(distancias)
```

```{r}
outliers <- as.numeric(names(sort(distancias, decreasing = T)[1:400]))
```














