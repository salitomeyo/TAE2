---
title: ''
author: "Jennifer Salazar"
date: "28/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Procedimientos para llegar a la segmentación 

Ya que se tuvo una exploración de las diferentes variables de canales y financieras, se pudo comprender mediante estas que el comportamiento de los clientes en este tipo de variables es muy particular, ya que las variables asociadas a los canales nos dan a entender mejor como usa el cliente la compañia y las variables financieras nos ayudan a entender que necesita el cliente de la compañia a partir de las caracteristicas de este y es por este motivo que se considera que los procedimientos de segmentación de clientes se deben hacer de manera independiente entre las variables de los canales y las variables financieras, dado que se espera que salgan grupos muy diferentes realizando la segmentación mediante estos dos tipos de variables debido a que cada una estudia perspectivas muy diferentes del cliente, se concilio realizar el proceso de segmentación por un tipo de variable y luego realizar subgrupos por el otro tipo de variable a partir de los grupos creados inicialmente.

En este caso se decide realizar una segmentación mediante las variables asociadas a los canales y en cada uno de los grupos que se obtengan a partir de esta se va a realizar una segmentación adicional (subgrupos) teniendo en cuenta las variables financieras, de tal manera que cada grupo final se caracterice por tener un comportamiento particular tanto en las variables de los canales como en las variables financieras.

Las variables de los canales son variables cuantitativas, las cuales en general cuenta con valores extremos los cuales al ser utilizados en la segmentación pueden crear un gran impacto en los grupos resultantes, dado que el algoritmo que se usa "K-means" es muy sensible a observaciones extremas, por lo tanto para solucionar este problema se decide realizar una transformación logaritmo natural sobre las variables asociadas a los canales.


**(¿Por qué realizar la transformación de logaritmo natural?)** recuerden poner un link de desplazamiento................

Además de ello el algoritmo de segmentación K-means es muy sensible a las unidades de las diferentes variables dado que es un basado en distancias, por lo que asi se aplique una transformación logaritmo natural, se deben de escalar las variables para que todas las variables puedas ser comparadas entre si y los resultados sean estadisticamente validos.


**¿Por qué escalar las variables para realizar las agrupaciones?** recuerden poner un link de desplazamiento................



```{r, echo =FALSE}
# Lectura de la base de datos original
df <- read.csv("base_trabajo_segmentacion.csv", sep = ";", dec = '.', header = T)
df <- df[, -1]

# Separación de las variables financieras y canales

# Se crea un conjunto con las variables sin escalar
finan_no_scaled <- df[, 31:46]
Canal_no_scaled <- df[ , 1:30]

# Se crea un conjunto con las variables escaladas
df_scaled <- scale(df, center = T, scale = T)
Canal_scaled <- df_scaled[,1:30]
finan_scaled <- df_scaled[,31:46]

# Se aplica transformación logaritmo natural a los canales y se escala
Canal_log <- log(Canal_no_scaled + 1) 
Canal_log_scaled <- scale(log(Canal_no_scaled + 1), center = T, scale = T)
```


## Procedimiento de segmentación 1

A continuación se presenta el  procedimiento desarrollado realizando una segmentación con todas las variables asociadas a los canales, primero a estas se les aplica logaritmo natural y luego se escalan, posteriormente en cada uno de los grupos resultantes se realiza una subagrupación pero solo teniendo en cuenta las variables financieras:

* Se utiliza agrupamiento jerarquico con la idea de conocer la cantidad de grupos que se deben considerar 

```{r, echo =FALSE, message=FALSE, warning=FALSE}
library(ggdendro)
library(ggplot2)
require(factoextra)

dendrogram <- hclust(dist(Canal_log_scaled, method = 'euclidean'), method = 'ward.D')


plot(dendrogram, xlab="", sub="", cex=0.9)
rect.hclust(dendrogram, k=2, border="cyan4")


# fviz_dend(x = dendrogram, k = 2, cex = 0.6) +
#   geom_hline(yintercept = 1400, linetype = "dashed") +
#   labs(title = "Dendograma")
```

* Del gráfico se concluye adecuado considerar dos grupos.



* Agrupamiento k means con las variables de los canales (usando transformación logaritmo natural):

```{r}
require(cluster)

set.seed(93285)
Agru_canal<- kmeans(Canal_log_scaled, 2 , nstart = 5, iter.max = 100)

clusplot(Canal_log_scaled, Agru_canal$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1, 
          col.clus = c("darkgreen", "darkblue"),
          col.p = ifelse(Agru_canal$cluster == 2, "darkblue","darkgreen"), 
          main = "Grupos seleccionados por Kmeans", 
          xlab = "Componente principal 1 canales",
          ylab = "Componente principal 2 canales",
          sub = "")
grid()
```

En el gráfico anterior se puede observar una representación en dos dimensiones de los grupos encontrados por K-means. 


- Se agrega la variable que indica el grupo al conjunto de datos

```{r}
grupos <- as.factor(Agru_canal$cluster) # Se extraen los grupos

# Se agrega a los canales la variable grupo
canal_group <- data.frame(grupos, Canal_no_scaled)
head(canal_group)
```

- Valor medio de cada variable en canal discriminada por grupo

```{r}
aggregate(.~grupos, data=canal_group, FUN = mean)
```

- Número de clientes en cada uno de los grupos

```{r}
table(Agru_canal$cluster)
```


El grupo 1 cuenta con 1281 clientes y el grupo 2 con 952 clientes de los cuales en general el grupo 1 tiene a los clientes que tienden a manejar montos más altos de dinero y mayor número de transacciones por todos los canales en comparación con los del grupo 2.


* Gráficos de boxplot que permitirán sacar caraterísticas de cada uno de los grupos

```{r}
library(ggplot2)
for(i in 2:dim(canal_group)[2]){
 
 p <-  ggplot(canal_group, aes(x = factor(grupos), y=log(canal_group[, i]+1))) +  
   geom_boxplot() +
   geom_jitter(color="darkblue", size=0.4, alpha=0.9) +
    labs(x = colnames(canal_group)[i], y = "Escala log natural") +
    theme_gray() 
    
  
  print(p)
}

```

- En términos generales, se puede observar que el grupo 1 presenta en promedio un monto y un número mayor de transacciones.

- Se puede notar una mayor dispersión del grupo 2 en los canales de entrada 3, 6, 8, y 9 y en el grupo1 en el canal otros. 
- en general en los canales de entrada asociados al número de transaciones el grupo 1 presenta una mayor dispersión, en parte debido a una mayor cantidad de valores extremos.

- En los canales de salida, tanto para montos como para transacciones, el grupo 1 parece estar más disperso en el canal 5, mientras que el grupo 2 lo esta en el canal 2, en el resto de canales el comportamiento es similar aunque el grupo 1 presenta más valores extremos. 



```{r}
df_scaled_group <- data.frame(grupos, Canal_log_scaled, finan_scaled)

grupo1_scaled <- df_scaled_group[df_scaled_group$grupos==1,]
grupo2_scaled <- df_scaled_group[df_scaled_group$grupos==2,]

df_group <- data.frame(grupos,df)

grupo1_no_scaled <- df_group[df_group$grupos==1,]
grupo2_no_scaled <- df_group[df_group$grupos==2,]

df_group_log <- df_group
df_group_log[, 2:31] <- log(df_group[, 2:31] + 1)

media_df_grupcanal <-  aggregate(.~grupos,data=df_group_log, FUN=mean)

```



* Análisis del valor medio de los grupos en cada variable


```{r}
plot(1:30, media_df_grupcanal[1, 2:31], type = 'b', col = 'darkgreen', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim  = c(0, 22))
axis(1, 1:30, names(media_df_grupcanal)[2:31], las = 2)
lines(1:30, media_df_grupcanal[2, 2:31], col = 'darkblue', type = "b", lwd = 2)


legend(25, 23, legend=c("Grupo1","Grupo2"),
       col=c("darkgreen", "darkblue"), lty=c(1, 1, 1, 3), lwd = 2, cex = 0.8, bty = 'n')
grid()
```


De la gráfica anterior, se puede ver en general un comportamiento similar entre ambos grupos, sin embargo, el grupo 1 presenta un monto y un número mayor de transacciones promedio. Siendo la diferencia más amplia en los canales de entrada 3, 5, 6, 8, 9 y en los canales de salida 5 y 2.



```{r}
par(mfrow=c(1,3))
plot(1:5, media_df_grupcanal[1, 32:36], type = 'b', col = 'darkgreen', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim=c(0, 5.5))
axis(1, 1:5, names(media_df_grupcanal)[32:36], las = 2)
lines(1:5, media_df_grupcanal[2, 32:36], col = 'darkblue', type = "b", lwd = 2)

legend("bottomright", legend=c("Grupo1","Grupo2"),
       col=c("darkgreen", "darkblue"), lty=1, bty = 'n')
grid()


plot(1:6, media_df_grupcanal[1, 37:42], type = 'b', col = 'darkgreen', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim = c(0, 1))
axis(1, 1:6, names(media_df_grupcanal)[37:42], las = 2)
lines(1:6, media_df_grupcanal[2, 37:42], col = 'darkblue', type = "b", lwd = 2)

legend("topright", legend=c("Grupo1","Grupo2"),
       col=c("darkgreen", "darkblue"), lty=1, bty = 'n')
grid()

plot(1:5, media_df_grupcanal[1, 43:47], type = 'b', col = 'darkgreen', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim = c(0, 5.5))
axis(1, 1:5, names(media_df_grupcanal)[43:47], las = 2)
lines(1:5, media_df_grupcanal[2, 43:47], col = 'darkblue', type = "b", lwd = 2)

legend("bottomright", legend=c("Grupo1","Grupo2"),
       col=c("darkgreen", "darkblue"), lty=1, bty = 'n')
grid()
```

Dado que el grupo 1 maneja montos de dinero y número de transacciones promedio más grandes en los canales, a su vez, se pueden observar valores promedios más grandes en las cuentas por pagar, cuentas por cobrar y en el total de inventario y aunque en el número de importaciones y exportaciones promedio es mayor que la del grupo 2, la diferencia es muy pequeña, además el grupo 1 tiende a tener una mayor proporción de tiendas fisicas. En las demás variables el comportamiento promedio es bastante similar.

---

## Se crean subgrupos mediante las variables financieras para cada grupo creado con canales


* Agrupamiento por variables financieras para el grupo 1 de canales:


- Se utiliza agrupamiento jerárquico con la idea de conocer la cantidad de grupos que se deben considerar 

```{r}
dendrogram <- hclust(dist(grupo1_scaled[,32:47], method = 'euclidean'), method = 'ward.D')

plot(dendrogram, xlab="", sub="", cex=0.9)
rect.hclust(dendrogram, k=3, border="cyan4")
```

Del dendograma anterior se concluye considerar 3 subgrupos.


Subagrupamientos mediante las variables de estados financieros usando k-means :


```{r}
require(cluster)

get_color_grupo1 <- function(valor){
  
  if(valor == 1){
    return("#B2F768") 
  }
  else if (valor == 2){
    return("#46EB65")
  }
  else{
    return("#206B2E")
  }
  
}

set.seed(9325)
kc1 <- kmeans(grupo1_scaled[,32:47], 3 , nstart = 5, iter.max = 100)

clusplot(grupo1_scaled[,32:47], kc1$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.clus = c("#46EB65", "#206B2E", "#B2F768"),
          col.p = sapply(kc1$cluster, get_color_grupo1), 
          main = "Subgrupos seleccionados por Kmeans", 
          xlab = "Componente principal 1 canales",
          ylab = "Componente principal 2 canales",
          sub = "")
grid()


```

```{r}
table(kc1$cluster)

```

Nuevamente se le agrega al conjunto de datos la variable que indica el sub-grupo a partir de la segmentación con K-means en las variables financieras


```{r}
canal1_finan <- data.frame(sub_grupos=kc1$cluster, grupo1_no_scaled)
canal1_finan$sub_grupos <- as.factor(canal1_finan$sub_grupos)
head(canal1_finan)
```



```{r, echo = FALSE}

canal1_finan_log <- canal1_finan
canal1_finan_log[, 3:32] <- log(canal1_finan_log[, 3:32] + 1)

media_canal1_finan <-  aggregate(.~sub_grupos,data=canal1_finan_log, FUN=mean)

```



* Análisis del valor medio de los grupos en cada variable


```{r}
plot(1:30, media_canal1_finan[1, 3:32], type = 'b', col = get_color_grupo1(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim  = c(0, 22))
axis(1, 1:30, names(media_canal1_finan)[3:32], las = 2)
lines(1:30, media_canal1_finan[2, 3:32], col = get_color_grupo1(2), type = "b", lwd = 2)
lines(1:30, media_canal1_finan[3, 3:32], col = get_color_grupo1(3), type = "b", lwd = 2)


legend(25, 23, legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c(get_color_grupo1(1), get_color_grupo1(2), get_color_grupo1(3)), lty=c(1, 1, 1, 3), lwd = 2, cex = 0.8, bty = 'n')
grid()
```


De la grafica presentada previamente se espera que los tres grupos tengan un comportamiento y valores promedios muy similares, dado que esta siendo graficada en las variables asociados a los canales y estos sub grupos fueron hallados a partir del grupo 1 de las variables de los canales, por lo tanto se espera que es estos tres grupos, tengan sus diferencias en las variables financieras pero muy similares en los canales.  



```{r}
plot(1:16, media_canal1_finan[1, 33:48], type = 'b', col = get_color_grupo1(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:16, names(media_canal1_finan)[33:48], las = 2)
lines(1:16, media_canal1_finan[2, 33:48], col = get_color_grupo1(2), type = "b", lwd = 2)
lines(1:16, media_canal1_finan[3, 33:48], col = get_color_grupo1(3), type = "b", lwd = 2)

legend("bottomright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c(get_color_grupo1(1), get_color_grupo1(2), get_color_grupo1(3)), lty=1, bty = 'n')
grid()
```


* Los tres grupos toman valores promedios diferentes en las distintas variables financieras, lo que indica la diferencia esperada en estas variables.

* El sub-grupo 1 del grupo 1 tiende a tener el mayor número promedio de importaciones, exportaciones, inventarios y además de ello es al que le toma más tiempo realizar las rotaciones de inventarios, rotaciones de cuenta por cobrar y pagar y realizar los ciclos de negocio y financieros. a los pagos y recaudos a personas juridicas y naturales tiende a tener porcentajes bajos.

* El sub-grupo 2 del grupo 1 en comparación a los otros grupos, tiende a tener un número promedio o intermedio de importaciones, exportaciones, inventarios, al igual que las rotaciones de inventarios, rotaciones de cuenta por cobrar y pagar y realizar los ciclos de negocio y financiero, pero cabe aclarar que es el que tiene mayor número promedio de cuentas por cobrar y cuentas por pagar, pagos a personas juridicas y naturales, recaudos a personas juridicas y naturales, además que es el que cuenta con mayor número de tiendas fisicas y electronicas.

* El sub-grupo 3 del grupo 1 es el que en general tiende a tener menores niveles promedios en todas las variables financieras, es decir es el que realiza menos importaciones, exportaciones, tiene menores cuentas por cobrar y por pagar, menores inventarios, le toma menos tiempo realizar las rotaciones de inventarios, rotaciones de cuenta por cobrar y pagar y realizar los ciclos de negocio y financieros. a los pagos y recaudos a personas juridicas y naturales tiende a tener porcentajes bajos.

###############################################

* Agrupamiento por variables financieras para el grupo 2 de canales:


- Se utiliza agrupamiento jerárquico con la idea de conocer la cantidad de grupos que se deben considerar 


```{r}
dendrogram <- hclust(dist(grupo2_scaled[, 32:47], method = 'euclidean'), method = 'ward.D')

plot(dendrogram, xlab="", sub="", cex=0.9)
```

Del dendograma anterior se concluye considerar 3 subgrupos.


Subagrupamientos mediante las variables de estados financieros usando k-means :


```{r}
require(cluster)

get_color_grupo2 <- function(valor){
  
  if(valor == 1){
    return("#48D9FB") 
  }
  else if (valor == 2){
    return("#0669AC")
  }
  else{
    return("#000080")
  }
  
}


require(cluster)

set.seed(9326)
kc2 <- kmeans(grupo2_scaled[, 32:47], 3, nstart = 5, iter.max = 100)

clusplot(grupo2_scaled[,32:47], kc2$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.clus = c("#0688AC", "#0669AC", "#000080"),
          col.p = sapply(kc2$cluster, get_color_grupo2), 
          main = "Subgrupos seleccionados por Kmeans", 
          xlab = "Componente principal 1 canales",
          ylab = "Componente principal 2 canales",
          sub = "")
grid()


```


```{r}
table(kc2$cluster)
```


Nuevamente se le agrega al conjunto de datos la variable que indica el sub-grupo a partir de la segmentación con K-means en las variables financieras


```{r}
canal2_finan <- data.frame(sub_grupos=kc2$cluster, grupo2_no_scaled)
canal2_finan$sub_grupos <- as.factor(canal2_finan$sub_grupos)
head(canal2_finan)
```



```{r, echo = FALSE}
canal2_finan_log <- canal2_finan
canal2_finan_log[, 3:32] <- log(canal2_finan_log[, 3:32] + 1)

media_canal2_finan <-  aggregate(.~sub_grupos,data=canal2_finan_log, FUN=mean)

```



* Análisis del valor medio de los grupos en cada variable


```{r}
plot(1:30, media_canal2_finan[1, 3:32], type = 'b', col = get_color_grupo2(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim  = c(0, 22))
axis(1, 1:30, names(media_canal2_finan)[3:32], las = 2)
lines(1:30, media_canal2_finan[2, 3:32], col = get_color_grupo2(2), type = "b", lwd = 2)
lines(1:30, media_canal2_finan[3, 3:32], col = get_color_grupo2(3), type = "b", lwd = 2)


legend(25, 23, legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c(get_color_grupo2(1), get_color_grupo2(2), get_color_grupo2(3)), lty=c(1, 1, 1, 3), lwd = 2, cex = 0.8, bty = 'n')
grid()
```


De la grafica presentada previamente se espera que los tres grupos tengan un comportamiento y valores promedios muy similares, dado que esta siendo graficada en las variables asociados a los canales y estos sub grupos fueron hallados a partir del grupo 2 de las variables de los canales, por lo tanto se espera que es estos tres grupos, tengan sus diferencias en las variables financieras pero muy similares en los canales.  



```{r}
plot(1:16, media_canal2_finan[1, 33:48], type = 'b', col = get_color_grupo2(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:16, names(media_canal2_finan)[33:48], las = 2)
lines(1:16, media_canal2_finan[2, 33:48], col = get_color_grupo2(2), type = "b", lwd = 2)
lines(1:16, media_canal2_finan[3, 33:48], col = get_color_grupo2(3), type = "b", lwd = 2)

legend("bottomright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c(get_color_grupo2(1), get_color_grupo2(2), get_color_grupo2(3)), lty=1, bty = 'n')
grid()
```


* Los tres grupos toman valores diferentes en las distintas variables financieras, lo que indica la diferencia esperada en estas variables.

* El sub-grupo 1 del grupo 2 tiende a tener un número promedio intermedio de importaciones, pocas exportaciones, tiene la menor cantidad de cuentas por pagar, y una cantidad promedio de inventario, además es el grupo que le toma mayor tiempo realizar las rotaciones de inventarios, realizar los ciclos de negocio y financieros, pero para realizar las rotaciones de cuentas por cobrar y pagar si toma valores más intermedios.

* El sub-grupo 2 del grupo 2 es el que realiza mayor número promedio de importaciones y exportaciones, el que más cuenta por pagar y cobrar tiene, además de mayor inventario, además el que le toma mayor tiempo de hacer las rotaciones de cuentas por cobrar y pagar, pero tiene un número intermedio de rotaciones de inventario, ciclo de negocio y financiero.

* El sub-grupo 3 del grupo 2 es el que tiene menor número promedio de importaciones y exportaciones, el que menos cuentas por cobrar tiene, además de la menor cantidad de inventario, por otro lado también es el que le tarda menos tiempo realizar las rotaciones de inventario, de cuentas por cobrar y pagar, de realizar su ciclo de negocio y financiero.

En general, los tres grupos tienen un comportamiento muy similar en los pagos y recaudos a personas naturales y juridicas y en las ventas fisicas y electronicas.


**Grupos finales** 

Dado que en los procedimientos anteriores se obtuvieron grupos y subgrupos, ahora llega el momento de crear los 6 grupos resultates, que consiste en la combinación de un grupo y subgrupo respectivamente: 


Grupo 1: grupo 1 subgrupo 1
Grupo 2: grupo 2 subgrupo 1
Grupo 3: grupo 1 subgrupo 2
Grupo 4: grupo 2 subgrupo 2
Grupo 5: grupo 1 subgrupo 3
Grupo 6: grupo 2 subgrupo 3

```{r}
Grupo1 <- canal1_finan[canal1_finan$sub_grupos==1,] # grupo 1 subgrupo 1
Grupo2 <- canal2_finan[canal2_finan$sub_grupos==1,] # grupo 2 subgrupo 1

Grupo3 <- canal1_finan[canal1_finan$sub_grupos==2,] # grupo 1 subgrupo 2
Grupo4 <- canal2_finan[canal2_finan$sub_grupos==2,] # grupo 2 subgrupo 2

Grupo5 <- canal1_finan[canal1_finan$sub_grupos==3,] # grupo 1 subgrupo 3
Grupo6 <- canal2_finan[canal2_finan$sub_grupos==3,] # grupo 2 subgrupo 3


Grupos <- c(rep(1, dim(Grupo1)[1]), rep(2, dim(Grupo2)[1]), rep(3, dim(Grupo3)[1]), rep(4, dim(Grupo4)[1]), rep(5, dim(Grupo5)[1]), rep(6, dim(Grupo6)[1]))

Datos_finales_2 <- rbind(Grupo1, Grupo2, Grupo3, Grupo4, Grupo5, Grupo6)

# Grupo7, Grupo8, Grupo9
Datos_finales_2 <- data.frame(Grupos, Datos_finales_2)
Datos_finales_2
```



```{r}
Datos_finales_2_log <- Datos_finales_2

Datos_finales_2_log[4:33] <- log(Datos_finales_2_log[4:33] + 1)
```


* Media de los grupos 

```{r}
media_canal_finan <- aggregate(.~Grupos,data=Datos_finales_2_log, FUN=mean)
media_canal_finan 
```


* Mediana de los grupos

```{r}
aggregate(.~Grupos,data=Datos_finales_2, FUN=median)
```


* Análisis del valor medio de los grupos en cada variable

```{r}
plot(1:30, media_canal_finan [1, 4:33], type = 'b', col = '#E80EB8', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0, 22))
axis(1, 1:30, names(media_canal_finan )[4:33], las = 2)
lines(1:30, media_canal_finan [2, 4:33], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:30, media_canal_finan [3, 4:33], col = '#19DBAD', type = "b", lwd = 2)
lines(1:30, media_canal_finan [4, 4:33], col = '#92F20F', type = "b", lwd = 2)
lines(1:30, media_canal_finan [5, 4:33], col = '#EBA81A', type = "b", lwd = 2)
lines(1:30, media_canal_finan [6, 4:33], col = '#8C7AF5', type = "b", lwd = 2)

legend("top", legend=c(paste("Grupo", 1:6, sep = '')),  col=c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')
```

* En general el grupo 1, 3 y 5 son los que manejan en promedio mayores montos de dinero y mayor número de transacciones, por lo tanto el grupo 2, 4 y 6 son los que manejan en promedio menores montos de dinero y menor número de transacciones.

* El grupo 3 a pesar de tener un comportamiento de manejar mayores montos en promedio de dinero al igual que el grupo 1 y 5, este se destaca particularmente en el canal de entrada de otros, dado que toma valores muy altos, más que cualquiera de los otros grupos.

```{r}
par(mfrow=c(1,3))
plot(1:5, media_canal_finan [1, 34:38], type = 'b', col = "#E80EB8", 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0,5.5))
axis(1, 1:5, names(media_canal_finan )[34:38], las = 2)
lines(1:5, media_canal_finan [2, 34:38], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:5, media_canal_finan [3, 34:38], col = '#19DBAD', type = "b", lwd = 2)
lines(1:5, media_canal_finan [4, 34:38], col = '#92F20F', type = "b", lwd = 2)
lines(1:5, media_canal_finan [5, 34:38], col = '#EBA81A', type = "b", lwd = 2)
lines(1:5, media_canal_finan [6, 34:38], col = '#8C7AF5', type = "b", lwd = 2)
grid()

legend("bottom", legend=c(paste("Grupo", 1:6, sep = '')),  col = c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')


plot(1:6, media_canal_finan [1, 39:44], type = 'b', col = "#E80EB8", 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0,1))
axis(1, 1:6, names(media_canal_finan )[39:44], las = 2)
lines(1:6, media_canal_finan [2, 39:44], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:6, media_canal_finan [3, 39:44], col = '#19DBAD', type = "b", lwd = 2)
lines(1:6, media_canal_finan [4, 39:44], col = '#92F20F', type = "b", lwd = 2)
lines(1:6, media_canal_finan [5, 39:44], col = '#EBA81A', type = "b", lwd = 2)
lines(1:6, media_canal_finan [6, 39:44], col = '#8C7AF5', type = "b", lwd = 2)
grid()
legend("topright", legend=c(paste("Grupo", 1:6, sep = '')),  col = c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')


plot(1:5, media_canal_finan [1, 45:49], type = 'b', col = "#E80EB8", 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0,5.5))
axis(1, 1:5, names(media_canal_finan )[45:49], las = 2)
lines(1:5, media_canal_finan [2, 45:49], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:5, media_canal_finan [3, 45:49], col = '#19DBAD', type = "b", lwd = 2)
lines(1:5, media_canal_finan [4, 45:49], col = '#92F20F', type = "b", lwd = 2)
lines(1:5, media_canal_finan [5, 45:49], col = '#EBA81A', type = "b", lwd = 2)
lines(1:5, media_canal_finan [6, 45:49], col = '#8C7AF5', type = "b", lwd = 2)
grid()
legend("bottom", legend=c(paste("Grupo", 1:6, sep = '')),  col = c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')
```


* El grupo 1, 3 y 4 es el que realiza mayor número promedio de importaciones y exportaciones, tiene mayor número promedio de cuentas por pagar y cobrar y mayor inventario, por otro lado el grupo 2, 5 y 6 es el que realiza menor número promedio de importaciones y exportaciones, tiene menor número promedio de cuentas por pagar y cobrar y menor inventario, pero respecto al inventario el grupo 2 es el que tiene mas en comparación con los grupos 5 y 6 a pesar de que es el que tiene menor numero promedio de cuentas por pagar.

* En general todos los grupos presentan mayor número promedio de ventas fisicas que electronicas, además el grupo 3 es el que presenta mayor promedio de pagos a personas naturales, mayor número promedio de ventas fisicas y electronicas y mayor número promedio de recaudos a personas juridicas y naturales. El grupo 2 y 6 es el que realiza mayor proporción de pagos a personas juridicas, pero son los que realizan menor proporción de pagos a personas naturales, tiene la menor cantidad de ventas fisicas y electronicas, además de los menores recaudos a personas juridicas y naturales. El grupo 1, 4 y 5 toma valores intermedios.


* El grupo 1 y 2, el grupo 3 y 4, el grupo 5 y 6 tiene comportamientos muy similares en las rotaciones de inventario, de cuentas por cobrar y pagar y en los ciclos de negocio y financieros, en donde el grupo 5 y 6 es al que le toma menos tiempo promedio realizar estas rotaciones y ciclos, al grupo 1 y 2 le toma mayor tiempo promedio realizar las rotaciones de inventario y hacer los ciclos de negocio y financiero, por otro lado el grupo 4 es al que más tiempo promedio le toma realizar las rotaciones de cuenta por cobrar y pagar.

En general asi los grupos se parezcan entre si, estos se difieren en algo, ya sea en las variables financieras o en los canales.

### Conclusión general de los grupos formados


* Grupo 1: es de los que tiende a manejar mayores montos de dinero y mayor número de transacciones a través de los canales, además de que es el grupo que mayores importaciones y exportaciones realiza, tiene buena cantidad de cuentas por cobrar y pagar además de una gran cantidad de inventarios, maneja muchas ventas fisicas, se demora más rotando el inventario y realizando su ciclo de negocio y financiero, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas grandes, de productos, por ello manejan mucho inventario y se demoran mucho para rotarlo, además de que venden y compran productos al exterior.

* Grupo 2: es de los que tiende a manejar menores montos de dinero y menor número de transacciones a través de los canales, realizan pocas importaciones y exportaciones, tienen pocas cuentas por pagar y aunque tiene mas cuentas por cobrar, tampoco estas son altas, tiene un inventario de un nivel intermedio, es el grupo que tiene mayor porcentaje de pagos a personas juridicas que a personas naturales, además de menores ventas fisicas  y electronicas, es decir las menores ventas en general, además de ser el grupo que más se demora rotando el inventario y realizando el su ciclo de negocio y financiero, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que quizas no estan tan desarrolladas y estan en un proceso de crecimiento, en donde sus ventas no son las mejores y no tiene tanto contacto a nivel internacional.


* Grupo 3: es el que tiene mayores montos de dinero y mayor número de transacciones a través de los canales, no tiene un nivel alto de importaciones y exportaciones, tiene relativamente un nivel alto en la cuentas por pagar, cuentas por cobrar e inventario, además el grupo 3 es el que presenta mayor promedio de pagos a personas naturales, mayor número de ventas fisicas y electronicas y mayor número de recaudos a personas juridicas y naturales y en general tiene un nivel promedio en las rotaciones y ciclos, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas grandes que se mueven más a nivel nacional, tienen muchas ventas ya sean fisicas o electronicas y sus rotaciones de inventario y de cuentas al igual que si sus ciclos no tienden a ser tan rapidos ni tan lentos (ejemplos: almacenes de cadena)

* Grupo 4: es de los que tiende a manejar menores montos de dinero y menor número de transacciones a través de los canales, tiene un nivel medio de importaciones y exportaciones y un nivel muy alto de cuenta por cobrar y pagar, también dispone de un nivel alto de inventario, su nivel de ventas es intermedio al igual que la rotación de inventario y ciclo de negocio y financiero y en comparación con los otros grupos es el que tiene las rotaciones de cuentas por cobrar y pagar más lenta,  por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que ofrecen un servicio o producto en donde su forma de pago no es inmediata, como por ejemplo empresas que realizan pedidos o encargos, empresas distribuidores, etc.

* Grupo 5: es de los que tiende a manejar mayores montos de dinero y mayor número de transacciones a través de los canales, tiene un nivel bajo de importaciones y exportaciones y un nivel intermedio de cuentas por cobrar, cuentas por pagar e inventario, también tiene un alto porcentaje de pagos a personas juridicas y naturales, además un buen porcentaje de ventas fisicas y en general tiene rotaciones de inventario, rotaciones de cuentas y ciclos relativamente rápidos, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que se encargan de distribuir productos nacionales, los cuales tienen un proceso de venta rápido, dado que el inventario no es grande ni pequeño pero tienden a realizar rotaciones en poco tiempo y por el hecho de manejar buen monto de dinero nos da idea de que puede ser una empresa grande o muy bien acreditada.

* Grupo 6: es de los que tiende a manejar menores montos de dinero y menor número de transacciones a través de los canales, tiene niveles bajos de importaciones, exportaciones, de cuentas por cobrar y pagar e inventario, tiene porcentajes altos de pagos a personas juridicas y naturales y sus rotaciones de inventario, de cuentas y ciclos son rápidos, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que en general se espera que no sean grandes y tiendan a ofrecer servicios a nivel nacional.

_Comentario adicional:_

Los valores extremos encontrados inicialmente en los canales son los siguientes:

"825, 1416, 1462, 1668, 1773"

Los cuales pertenecen al grupo:

"5, 3, 3, 1, 3" respectivamente lo cual significa que todos quedan en los grupos que más dinero mueven y más tranzan por los canales, por lo tanto la segmentación es confiable.

################################################################################

conclusión:

En la segmentación (primero canales luego financieras) anterior se obtuvieron muy buenos resultados dado que se puedo interpretar de manera acertada cada uno de los grupos formados, ahora se intenta realizar el proceso de segmentación con un procedimiento contrario (primero financieras luego canales) con el fin de observar si se obtienen grupos similares a los obtenidos hasta ahora, para mirar si hay consistencia con los análisis realizados y mirar si hay influencia alta de hacer los procedimientos en un orden especifico.

<br>


## Procedimiento de segmentación 2

A continuación se presenta el  procedimiento desarrollado realizando una segmentación con todas las variables financieras, para ser ingresadas al algoritmo de segmentación siendo escaladas, posteriormente en cada uno de los grupos resultantes se realiza una subagrupación pero solo teniendo en cuenta las variables asociadas a los canales, las cuales se les aplica logaritmo natural y luego son escaladas:

* Se utiliza agrupamiento jerarquico con la idea de conocer la cantidad de grupos que se deben considerar 


```{r}
library(ggdendro)
library(ggplot2)
require(factoextra)

dendrogram <- hclust(dist(finan_scaled, method = 'euclidean'), method = 'ward.D')


plot(dendrogram, xlab="", sub="", cex=0.9)
rect.hclust(dendrogram, k=3, border="cyan4")
```

* Del gráfico se concluye adecuado considerar tres grupos.

<br>

* Agrupamiento k means con las variables financieras:

```{r}
require(cluster)

get_color <- function(valor){
  
  if(valor == 1){
    return("red") 
  }
  else if (valor == 2){
    return("purple")
  }
  else{
    return("blue")
  }
  
}
  

set.seed(93284)
Agru_finan <- kmeans(finan_scaled, 3 , nstart = 5, iter.max = 100)

clusplot(finan_scaled, Agru_finan$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.clus = c("purple", "red", "blue"),
          col.p = sapply(Agru_finan$cluster, get_color),
          main = "Grupos seleccionados por Kmeans", 
          xlab = "Componente principal 1 canales",
          ylab = "Componente principal 2 canales",
          sub = "")
```


En el gráfico anterior se puede observar una representación en dos dimensiones de los grupos encontrados por K-means. 


- Se agrega la variable que indica el grupo al conjunto de datos

```{r}
grupos <- as.factor(Agru_finan$cluster)

fina_group <- data.frame(grupos, finan_no_scaled)
head(fina_group)
```

- Valor medio de cada variable financiera discriminada por grupo


```{r}
aggregate(.~grupos, data=fina_group, FUN = mean)
```


- Número de clientes en cada uno de los grupos

```{r}
table(Agru_finan$cluster)
```





El grupo 1 cuenta con 809 clientes y el grupo 2 con 659 clientes  y el grupo 3 con 765 clientes.



* Gráficos que permitirán sacar caraterísticas de cada uno de los grupos

```{r}
library(ggplot2)
for(i in 2:dim(fina_group)[2]){
  
  if(class(fina_group[, i])=="integer"){
    p <- ggplot(fina_group, aes(x = fina_group[, i], y = ..prop..))+ geom_bar(fill = "#0c4c8a")+facet_grid(vars(), vars(grupos))
  }else{
    p <- ggplot(fina_group, aes(x = factor(grupos), y=fina_group[, i])) +  geom_boxplot()
  }
  
  p_final <- p +
    labs(x = colnames(fina_group)[i]) +
    theme_gray() 
    
  
  print(p_final)
}

```

**Grupo 1**

* impo_cv: El mayor número de observaciones tienen niveles de importaciones bajos, es decir el número de observaciones va disminuyendo a medida que aumenta el nivel de importaciones por lo que se podría decir que la mayoría tiende a importar menos, pero comparada con los demás grupos es el grupo en el que más se puede encontrar niveles de importaciones altos, ya que el cambio entre niveles es más leve.


* expo_vt: la mayor cantidad se concentra en el nivel 2 de exportaciones, continuando con el nivel 1, formando más de un 80% de observaciones en los dos primeros niveles es decir niveles de exportaciones bajos pero comparado con el grupo 3 hay mayor exportaciones.

* cxp:  Se acumulan en los primeros niveles, es decir tienden a tener un número menor de cuentas por pagar.

* cxc: Tiende a estar alrededor de todos los niveles, pero la mayoría se encuentra en los primeros  niveles indicando que el número de cuentas por cobrar no es tan alto.

* total inventory: Están alrededor de todos los niveles, pero la mayoría tiende a estar en el nivel 2 y 3 indicando que su inventario no es ni muy alto ni muy bajo.

* pagos_pj: En promedio tiene más pagos a personas jurídicas que el grupo 2 y 3.

* pagos_pn: En promedio el grupo 1 tiene menos pagos a personas naturales.

* tiene_ventas_fisicas: Es más frecuente encontrar que no tienen ventas físicas aunque no es mucha la diferencia con las que sí tienen tiendas físicas.

* tiene_ventas_electronicas: Es más frecuente encontrar que no tienen ventas electrónicas.

* recaudos_pj: La variable presenta muchos ceros, por lo tanto no se logra observar diferencias en los diferentes grupos.

* recaudos_pn: La variable presenta muchos ceros, por lo tanto no se logra observar diferencias en los diferentes grupos.

* rotacion_inventarios: La mayoría se acumula en el último nivel indicando que tiene una rotación lenta de inventarios.

* rotacion_cxc: Están alrededor de todos los niveles, aunque tiende a crecer la frecuencia a medida que aumentan los niveles, quedando mayor cantidad en los niveles más altos, lo que quiere decir que la rotación de las cuentas por cobrar es más bien lenta.

* rotacion_cxp: Están alrededor de todos los niveles, aunque su mayor frecuencia se observa en el nivel uno, indicando que rotan un poco rápido sus cuentas por pagar.

* ciclo_negocio: se acumulan en los últimos niveles indicando que se demoran más completando un ciclo de negocio.

* Ciclo_financiero: se acumulan en los últimos niveles indicando que se demoran más completando un ciclo financiero.


**Grupo 2**

* impo_cv: alrededor del 50% tiene un nivel de importación de 2 y el resto se encuentra alrededor de este, en general tiene un nivel de importación que no es alto.

* expo_vt: más del 70% se concentra en el nivel 2 de exportaciones lo que quiere decir que no tienen niveles de exportaciones ni altos ni bajos.

* cpx:  Se acumulan en los últimos niveles, es decir tienden a tener un número de cuentas por pagar alto.

* cxc: Tienden a acumularse en los últimos niveles indicando que el número de cuentas por cobrar es muy alto.

* total inventory: La mayoria se acumula en el último nivel (6)  indicando que a final de año tienen un inventario muy alto.

* pagos_pj: El grupo 2 presenta menor cantidad de pagos a personas jurídicas.

* pagos_pn: El grupo 2 presenta mayor cantidad de pagos a personas naturales.

* tiene_ventas_fisicas: Es más frecuente encontrar que  tienen ventas físicas aunque no es mucha la diferencia con las que no tienen tiendas físicas.

* tiene_ventas_electronicas:  Es más frecuente encontrar que no tienen ventas electrónicas.

* recaudos_pj: La variable presenta muchos ceros, por lo tanto no se logra observar diferencias en los diferentes grupos.

* recaudos_pn: La variable presenta muchos ceros, por lo tanto no se logra observar diferencias en los diferentes grupos.

* rotacion_inventarios: Tiende a estar alrededor de todos los niveles indicando que las rotaciones son muy variantes, aunque se podría decir que la mayoría está en los primeros niveles indicando que hay una rotación más o menos rápida.

* rotacion_cxc: Están alrededor de todos los niveles, aunque tiende a crecer la frecuencia a medida que aumentan los niveles, quedando mayor cantidad en los niveles más altos, lo que quiere decir que la rotación de las cuentas por cobrar es más bien lenta.

* rotacion_cxp: Están alrededor de todos los niveles, aunque su mayor frecuencia se observa en el nivel cuatro, indicando que rotan un poco más lento sus cuentas por pagar.

* ciclo_negocio: la mayoria se acumula en el nivel 4 indicando que el ciclo de negocio es lento pero no tanto

* ciclo_financiero:   la mayoria se acumula en el nivel 5 indicando que el ciclo financiero es lento pero no tanto como para llegar al nivel 6


**Grupo 3**

* impo_cv: El mayor porcentaje  tiene un nivel de importación muy bajo, y a medida que aumentan los niveles de importación se presentan menor número de observaciones (disminuye el numero de observaciones bruscamente).

* expo_cv: Lo niveles de exportaciones son muy bajos ya que más del 95% se acumula en los dos primeros niveles y en especial en el primer nivel son aproximadamente 60% lo que implica que en este grupo no se tiende mucho a exportar.

* cxp: Se acumulan en los primeros niveles, es decir tienden a tener un número de cuentas por pagar bajo(Similar al primer grupo).

* cxc: Tiende a estar alrededor de todos los niveles, pero la mayoría se encuentra en los primeros  niveles indicando que el número de cuentas por cobrar no es tan alto.

* total inventory: Tienden a acumularse en los dos primeros niveles indicando que el inventario a final del año es bajo.

* pagos_pj: El grupo 3 presenta una proporción intermedia de pagos a personas jurídicas.

* pagos_pn: El grupo 3 presenta una proporción intermedia de pagos a personas naturales.

* tiene_ventas_fisicas: Es más frecuente encontrar que no tienen ventas físicas aunque no es mucha la diferencia con las que sí tienen tiendas físicas.

* tiene_ventas_electronicas: Es más frecuente encontrar que no tienen ventas electrónicas.

* recaudos_pj: La variable presenta muchos ceros, por lo tanto no se logra observar diferencias en los diferentes grupos.

* recaudos_pn: La variable presenta muchos ceros, por lo tanto no se logra observar diferencias en los diferentes grupos.

* rotacion_inventarios: La mayoria tiende a acumularse en los primeros niveles indicando que hay una rotación de inventarios rápida.

* rotacion_cxc: Tienden a acumularse en los primero niveles indicando que la rotación de cuentas por cobrar es muy rápida.

* rotacion_cxp: Tienden a acumularse en los primero niveles indicando que la rotación de cuentas por pagar es muy rápida.

* ciclo_negocio: la mayoria se acumula entre los niveles 2 y 3 indicando que el ciclo de negocio es rápido pero no mucho 

* ciclo_financiero: la mayoria se acumula entre los niveles 2 y 3 indicando que el ciclo financiero es rápido pero no mucho 



**Conclusión general:**

El Grupo 3 es el que realiza menos importaciones  y el grupo 1 y  2 los que más realizan importaciones.

El grupo 3 es el que realiza menos exportaciones y el grupo 2 el que más realiza.

El grupo 1 y 3 tienen un número de cuentas por pagar pequeño en cambio el grupo 2 tiene muchas cuentas por pagar.

El grupo 1 y 3 tiene un número de cuentas por cobrar bajo, en cambio el grupo 2 tiene un número de cuentas por cobrar muy alto.

El grupo 2 es el que más tiene inventario a final de año y el grupo 3 el que menos inventario tiene.

El grupo 1 y 3 tiene menos ventas físicas y por el contrario el grupo 2 cuenta con más ventas físicas.

En los tres grupos no es frecuente encontrar ventas electrónicas.

El grupo 1 tiende a rotar el inventario muy lento en cambio el grupo 3 tiende a rotar muy rápido.

Las cuentas por cobrar de los grupos 1 y 2 rotan muy lento en cambio en el grupo 3 rotan muy rápido.

El grupo 1 y 3 tiende a rotar rápidamente las cuentas por pagar aunque es más rápido el 3 que el 1 y el grupo 2 tiende a rotar las cuentas por pagar más lento.

El grupo 1 tiene un ciclo de negocio muy lento, luego le sigue el grupo 2 con uno levemente lento y por último el grupo 3 tiene un ciclo de negocio levemente rápido.

El grupo 1 tiene un ciclo financiero muy lento, luego le sigue el grupo 2 con uno levemente lento y por último el grupo 3 tiene un ciclo financiero levemente rápido.




**Conclusión final:**

*El grupo 2 parece ser de productos y el grupo 3 parece ser de servicios y el grupo 1 tiene características similares  a los otros dos grupos






* Grupos de las variables escaladas 

```{r, echo=FALSE}
df_scaled_group <- data.frame(grupos, Canal_log_scaled, finan_scaled)

grupo1_scaled <- df_scaled_group[df_scaled_group$grupos==1,]
grupo2_scaled <- df_scaled_group[df_scaled_group$grupos==2,]
grupo3_scaled <- df_scaled_group[df_scaled_group$grupos==3,]

df_group <- data.frame(grupos, Canal_log, finan_no_scaled)

grupo1_no_scaled <- df_group[df_group$grupos==1,]
grupo2_no_scaled <- df_group[df_group$grupos==2,]
grupo3_no_scaled <- df_group[df_group$grupos==3,]


media_df_grupfin <- aggregate(.~grupos,data=df_group, FUN=mean)
media_df_grupfin

```



* Análisis del valor medio de los grupos en cada variable

```{r, echo=FALSE}

media_fin <- attr(df_scaled,"scaled:center")[31:46]

stdev_fin <-  attr(df_scaled,"scaled:scale")[31:46]

centroid1 <- apply(Agru_finan$centers, 1, function(x) x * attr(df_scaled,'scaled:scale')[31:46] + attr(df_scaled,'scaled:center')[31:46])

centroid1
```

```{r}
par(mfrow=c(1,3))
plot(centroid1[1:5, 1], type = 'b', col = 'red', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim=c(0, 5.5))
axis(1, 1:5, row.names(centroid1)[1:5], las = 2)
lines(centroid1[1:5, 2], col = 'purple', type = "b", lwd = 2)
lines(centroid1[1:5, 3], col = "blue", type = "b", lwd = 2)


legend("bottomright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c("red", "purple", "blue"), lty=1, bty = 'n')


plot(centroid1[6:11, 1], type = 'b', col = 'red', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim=c(0,1))
axis(1, 1:6, row.names(centroid1)[6:11], las = 2)
lines(centroid1[6:11, 2], col = 'purple', type = "b", lwd = 2)
lines(centroid1[6:11, 3], col = "blue", type = "b", lwd = 2)


legend("topright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c("red", "purple", "blue"), lty=1, bty = 'n')

plot(centroid1[12:16, 1], type = 'b', col = 'red', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim=c(0, 5.5))
axis(1, 1:5, row.names(centroid1)[12:16], las = 2)
lines(centroid1[12:16, 2], col = 'purple', type = "b", lwd = 2)
lines(centroid1[12:16, 3], col = "blue", type = "b", lwd = 2)


legend("bottomright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c("red", "purple", "blue"), lty=1, bty = 'n')
```


* Generalmente se observan comportamientos o valores promedios distintos entre los tres grupos conformados con las variables financieras, lo cual era de esperarse dado que la segmentación fue realizada solo con estas variables.

* El grupo 2 es el que tiende a tener mayores niveles medios de importaciones, exportaciones, cuentas por cobrar y pagar e inventario en comparación con los demás grupos.

* El grupo 1 y 3 tienen un nivel medio de cuentas por pagar muy similar, pero el grupo 1 tiene mayores importaciones, exportaciones, cuenta por cobrar e inventario que el grupo 3.


* El grupo 1 y el grupo 3 tienen mayores proporciones de pagos a personas juridicas que naturales, en cambio el grupo 2 mayores proporciones pagos a personas naturales que juridicas.

* Todos los grupos disponen de más ventas fisicas que electronicas.

* Todos los grupos tienden a tener más recaudos a personas naturales que a juridicas.


* La rotación de inventario promedio es más rápida para el grupo 3, luego para el grupo 2 y por último la más lenta para el grupo 1.

* La rotación promedio de cuentas por cobrar y pagar para el grupo 1 y 2 es muy similar, en cambio para el grupo 3 estas rotaciones son muy rápidas.

* El ciclo de negocio y financiero promedio es más rápido para el grupo 3, luego para el grupo 2 y por último el más lento para el grupo 1.


```{r}
plot(1:30, media_df_grupfin[1, 2:31], type = 'b', col = 'red', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim  = c(0, 22))
axis(1, 1:30, names(media_df_grupfin)[2:31], las = 2)
lines(1:30, media_df_grupfin[2, 2:31], col = 'purple', type = "b", lwd = 2)
lines(1:30, media_df_grupfin[3, 2:31], col = "blue", type = "b", lwd = 2)

legend(25, 23, legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c("red", "purple", "blue"), lty=c(1, 1, 1, 3), lwd = 2, cex = 0.8, bty = 'n')
```


* En general los tres grupos tienen comportamientos muy similares en las variables asociadas a los canales, pero el grupo 2 es el que tiende a tener montos y número de transacciones promedio un poco mayores a los otros grupos en los diferentes canales.

<br>

## Se crean subgrupos mediante las variables de los canales para cada grupo creado con las variables financieras


* Agrupamiento por variables de canales para el grupo 1 de financieras:


- Se utiliza agrupamiento jerárquico con la idea de conocer la cantidad de grupos que se deben considerar 



```{r}
dendrogram <- hclust(dist(grupo1_scaled[,2:31], method = 'euclidean'), method = 'ward.D')

plot(dendrogram, xlab="", sub="", cex=0.9)
```


* Del gráfico se concluye adecuado considerar dos grupos.



Subagrupamientos mediante las variables asociadas a los canales usando k-means :


```{r}
require(cluster)


get_color_grupo1 <- function(valor){
  
  if(valor == 1){
    return("#F77F6C") 
  }
  else if (valor == 2){
    return("#C23927")
  }
  
}


set.seed(932840)
kc1 <- kmeans(grupo1_scaled[,2:31], 2 , nstart = 5, iter.max = 100)

clusplot(grupo1_scaled[,2:31], kc1$cluster, color = TRUE, 
         shade = FALSE, labels = 4, lines = 1,
         col.clus = c("#F54830", "#C23927"),
         col.p = sapply(kc1$cluster, get_color_grupo1),
         main = "Subgrupos seleccionados por Kmeans", 
         xlab = "Componente principal 1 canales",
         ylab = "Componente principal 2 canales",
         sub = "" )
grid()
```

```{r}
table(kc1$cluster)
```


Nuevamente se le agrega al conjunto de datos la variable que indica el sub-grupo a partir de la segmentación con K-means en las variables de los canales:


```{r}
finan1_canal <- data.frame(sub_grupos=kc1$cluster, grupo1_no_scaled)
finan1_canal$sub_grupos <- as.factor(finan1_canal$sub_grupos)
head(finan1_canal)
```



* Media de los grupos

```{r}
media_finan1_canal <- aggregate(.~sub_grupos,data=finan1_canal, FUN=mean)

media_finan1_canal
```

<br>

* Análisis del valor medio de los grupos en cada variable

```{r}
plot(1:30, media_finan1_canal[1, 3:32], type = 'b', col = get_color_grupo1(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:30, names(media_finan1_canal)[3:32], las = 2)
lines(1:30, media_finan1_canal[2, 3:32], col = get_color_grupo1(2), type = "b", lwd = 2)


legend("top", legend=c("Grupo1","Grupo2"),  col=c(get_color_grupo1(1), get_color_grupo1(2)), lty=c(1, 1, 3), lwd = 2, bty = 'n')
```


* De la gráfica anterior, se puede ver en general un comportamiento similar entre ambos grupos, sin embargo, el grupo 1 presenta un monto y un número de transacciones promedio mayor al del grupo 2. Siendo la diferencia más amplia en los canales de entrada 3, 6, 8, 9 y en los canales de salida 5 y 2.



```{r}
plot(1:16, media_finan1_canal[1, 33:48], type = 'b', col = get_color_grupo1(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:16, names(media_finan1_canal)[33:48], las = 2)
lines(1:16, media_finan1_canal[2, 33:48], col = get_color_grupo1(2), type = "b", lwd = 2)

legend("topleft", legend=c("Grupo1","Grupo2"),  col=c(get_color_grupo1(1), get_color_grupo1(2)), lty=c(1, 1, 3), lwd = 2, bty = 'n')
```


* Ambos grupos tienen comportamientos y valores muy similares, dado que ambos provienen del grupo 1 formado por las variables financieras, por lo tanto estos dos grupos se diferencian en las variables de los canales, incluso, las pocas diferencias que se perciben en estas variables financieras, puede deberse a que el grupo 1 es el que tiende a tener mayores montos de dinero y hacer mayor número de transacciones a través de todos los canales, por lo que se percibe la relación que entre más dinero, mayores niveles de importaciones, exportaciones, cuentas por cobrar, pagar e inventario se van a realizar.


#########################################

* Agrupamiento por variables de canales para el grupo 2 de financieras:


- Se utiliza agrupamiento jerárquico con la idea de conocer la cantidad de grupos que se deben considerar 


```{r}
dendrogram <- hclust(dist(grupo2_scaled[,2:31], method = 'euclidean'), method = 'ward.D')

plot(dendrogram, xlab="", sub="", cex=0.9)
```


* En un inicio, del gráfico anterior se concluyó considerar 3 grupos. Sin embargo, después de realizar los agrupamientos mediante K-means se observó que dos de los grupos presentaban un comportamiento medio muy similar que hacia difícil su diferenciación. Por este motivo se decidió considerar únicamente 2 agrupaciones.



Subagrupamientos mediante las variables asociadas a los canales usando k-means :


```{r}
require(cluster)


get_color_grupo2 <- function(valor){
  
  if(valor == 1){
    return("#FF5CFF") 
  }
  else if (valor == 2){
    return("#800080")
  }
  
}



set.seed(93284)
kc2 <- kmeans(grupo2_scaled[,2:31], 2, nstart = 5, iter.max = 100)

clusplot(grupo2_scaled[,2:31], kc2$cluster, color = TRUE, 
         shade = FALSE, labels = 4, lines = 1,
         col.clus = c("#FF5CFF", "#800080"),
         col.p = sapply(kc2$cluster, get_color_grupo2),
         main = "Subgrupos seleccionados por Kmeans", 
         xlab = "Componente principal 1 canales",
         ylab = "Componente principal 2 canales",
         sub = "" )
grid()
```



```{r}
table(kc2$cluster)
```


Nuevamente se le agrega al conjunto de datos la variable que indica el sub-grupo a partir de la segmentación con K-means en las variables de los canales:


```{r}
finan2_canal <- data.frame(sub_grupos=kc2$cluster, grupo2_no_scaled)
finan2_canal$sub_grupos <- as.factor(finan2_canal$sub_grupos)
head(finan2_canal)
```



* Media de los grupos

```{r}
media_finan2_canal <-  aggregate(.~sub_grupos,data=finan2_canal, FUN=mean)
media_finan2_canal
```

<br>

* Análisis del valor medio de los grupos en cada variable

```{r}
plot(1:30, media_finan2_canal[1, 3:32], type = 'b', col = get_color_grupo2(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:30, names(media_finan2_canal)[3:32], las = 2)
lines(1:30, media_finan2_canal[2, 3:32], col = get_color_grupo2(2), type = "b", lwd = 2)

legend("top", legend=c("Grupo1","Grupo2"),  col=c(get_color_grupo2(1), get_color_grupo2(2)), lty=c(1, 1, 3), lwd = 2, bty = 'n')
```


* De la gráfica anterior, se puede ver en general un comportamiento similar entre ambos grupos, sin embargo, el grupo 1 presenta un monto y un número de transacciones promedio mayor al del grupo 2. Siendo la diferencia más amplia en los canales de entrada 3, 4 5, 8, 9 y otros, además en el canal de salida 5.


```{r}
plot(1:16, media_finan2_canal[1, 33:48], type = 'b', col = get_color_grupo2(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:16, names(media_finan2_canal)[33:48], las = 2)
lines(1:16, media_finan2_canal[2, 33:48], col = get_color_grupo2(2), type = "b", lwd = 2)


legend("topleft", legend=c("Grupo1","Grupo2"),  col=c(get_color_grupo1(1), get_color_grupo1(2)), lty=c(1, 1, 3), lwd = 2, bty = 'n')
```


* Ambos grupos tienen comportamientos y valores muy similares, dado que ambos provienen del grupo 2 formado por las variables financieras, por lo tanto estos dos grupos se diferencian en las variables de los canales, incluso, las pocas diferencias que se perciben en estas variables financieras, puede deberse a que el grupo 1 es el que tiende a tener mayores montos de dinero y hacer mayor número de transacciones a través de todos los canales, por lo que se percibe la relación que entre más dinero, mayor nivel de inventario se tiene, más tiendas fisicas y más rápidas las rotaciones de cuentas por cobrar y pagar.


#########################################

* Agrupamiento por variables de canales para el grupo 3 de financieras:


- Se utiliza agrupamiento jerárquico con la idea de conocer la cantidad de grupos que se deben considerar 


```{r}
dendrogram <- hclust(dist(grupo3_scaled[,2:31], method = 'euclidean'), method = 'ward.D')

plot(dendrogram, xlab="", sub="", cex=0.9)
```

* Del gráfico se concluye adecuado considerar dos grupos.




Subagrupamientos mediante las variables asociadas a los canales usando k-means :


```{r}
require(cluster)


get_color_grupo3 <- function(valor){
  
  if(valor == 1){
    return("#7070FF") 
  }
  else if (valor == 2){
    return("#00007A")
  }
  
}



set.seed(932840)
kc3 <- kmeans(grupo3_scaled[,2:31], 2 , nstart = 5, iter.max = 100)

clusplot(grupo3_scaled[,2:31], kc3$cluster, color = TRUE, 
         shade = FALSE, labels = 4, lines = 1,
         col.clus = c("#7070FF", "#00007A"),
         col.p = sapply(kc3$cluster, get_color_grupo3),
         main = "Subgrupos seleccionados por Kmeans", 
         xlab = "Componente principal 1 canales",
         ylab = "Componente principal 2 canales",
         sub = "" )
grid()
```

```{r}
table(kc3$cluster)
```


Nuevamente se le agrega al conjunto de datos la variable que indica el sub-grupo a partir de la segmentación con K-means en las variables de los canales:


```{r}
finan3_canal <- data.frame(sub_grupos=kc3$cluster, grupo3_no_scaled)
finan3_canal$sub_grupos <- as.factor(finan3_canal$sub_grupos)
head(finan3_canal)
```



* Media de los grupos

```{r}
media_finan3_canal <- aggregate(.~sub_grupos,data=finan3_canal, FUN=mean)
media_finan3_canal
```

<br>

* Análisis del valor medio de los grupos en cada variable

```{r}
plot(1:30, media_finan3_canal[1, 3:32], type = 'b', col = get_color_grupo3(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:30, names(media_finan3_canal)[3:32], las = 2)
lines(1:30, media_finan3_canal[2, 3:32], col = get_color_grupo3(2), type = "b", lwd = 2)


legend("top", legend=c("Grupo1","Grupo2"),  col=c(get_color_grupo3(1), get_color_grupo3(2)), lty=c(1, 1, 3), lwd = 2, bty = 'n')
```

* De la gráfica anterior, se puede ver en general un comportamiento similar entre ambos grupos, sin embargo, el grupo 1 presenta un monto y un número de transacciones promedio mayor al del grupo 2. Siendo la diferencia más amplia en los canales de entrada 3, 5 6, 8, 9 y en los canales de salida 5 y 2.



```{r}
plot(1:16, media_finan3_canal[1, 33:48], type = 'b', col = get_color_grupo3(1), 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide')
axis(1, 1:16, names(media_finan3_canal)[33:48], las = 2)
lines(1:16, media_finan3_canal[2, 33:48], col = get_color_grupo3(2), type = "b", lwd = 2)


legend("topleft", legend=c("Grupo1","Grupo2"),  col=c(get_color_grupo1(1), get_color_grupo1(2)), lty=c(1, 1, 3), lwd = 2, bty = 'n')
```



* Ambos grupos tienen comportamientos y valores muy similares, dado que ambos provienen del grupo 3 formado por las variables financieras, por lo tanto estos dos grupos se diferencian en las variables de los canales, incluso, las pocas diferencias que se perciben en estas variables financieras, puede deberse a que el grupo 1 es el que tiende a tener mayores montos de dinero y hacer mayor número de transacciones a través de todos los canales, por lo que se percibe la relación que entre más dinero, mayores nivel en las cuentas por cobrar e inventarios se tiene, además de más tiendas fisicas.


**Grupos finales** 


Dado que en los procedimientos anteriores se obtuvieron grupos y subgrupos, ahora llega el momento de crear los 6 grupos resultates, que consiste en la combinación de un grupo y subgrupo respectivamente: 


Grupo 1: grupo 1 subgrupo 1
Grupo 2: grupo 1 subgrupo 2
Grupo 3: grupo 2 subgrupo 1
Grupo 4: grupo 2 subgrupo 2
Grupo 5: grupo 3 subgrupo 1
Grupo 6: grupo 3 subgrupo 2

```{r}
Grupo1 <- finan1_canal[finan1_canal$sub_grupos==1,] #grupo 1 subgrupo 1
Grupo2 <- finan1_canal[finan1_canal$sub_grupos==2,] #grupo 1 subgrupo 2

Grupo3 <- finan2_canal[finan2_canal$sub_grupos==1,] #grupo 2 subgrupo 1
Grupo4 <- finan2_canal[finan2_canal$sub_grupos==2,] #grupo 2 subgrupo 2

Grupo5 <- finan3_canal[finan3_canal$sub_grupos==1,] #grupo 3 subgrupo 1
Grupo6 <- finan3_canal[finan3_canal$sub_grupos==2,] #grupo 3 subgrupo 2



Grupos <- c(rep(1, dim(Grupo1)[1]), rep(2, dim(Grupo2)[1]), rep(3, dim(Grupo3)[1]), rep(4, dim(Grupo4)[1]), rep(5, dim(Grupo5)[1]), rep(6, dim(Grupo6)[1]))


Datos_finales_3 <- rbind(Grupo1, Grupo2, Grupo3, Grupo4, Grupo5, Grupo6)

Datos_finales_3 <- data.frame(Grupos, Datos_finales_3)
Datos_finales_3
```

* Media de los grupos

```{r}
media_finan_canal <- aggregate(.~Grupos,data=Datos_finales_3, FUN=mean)
media_finan_canal
```


<br>

* Análisis del valor medio de los grupos en cada variable

```{r}
plot(1:30, media_finan_canal[1, 4:33], type = 'b', col = '#E80EB8', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0, 22))
axis(1, 1:30, names(media_finan_canal)[4:33], las = 2)
lines(1:30, media_finan_canal[2, 4:33], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:30, media_finan_canal[3, 4:33], col = '#19DBAD', type = "b", lwd = 2)
lines(1:30, media_finan_canal[4, 4:33], col = '#92F20F', type = "b", lwd = 2)
lines(1:30, media_finan_canal[5, 4:33], col = '#EBA81A', type = "b", lwd = 2)
lines(1:30, media_finan_canal[6, 4:33], col = '#8C7AF5', type = "b", lwd = 2)

legend("top", legend=c(paste("Grupo", 1:6, sep = '')),  col=c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')
```


* En general el grupo 1, 3 y 5 son los que manejan en promedio mayores montos de dinero y mayor número de transacciones, por lo tanto el grupo 2, 4 y 6 son los que manejan en promedio menores montos de dinero y menor número de transacciones.

* El grupo 3 a pesar de tener un comportamiento de manejar mayores montos en promedio de dinero al igual que el grupo 1 y 5, es el que toma mayores valores entre estos, además este se destaca particularmente en el canal de entrada de otros, dado que toma valores muy altos, más que cualquiera de los otros grupos.


```{r}
par(mfrow=c(1,3))
plot(1:5, media_finan_canal [1, 34:38], type = 'b', col = "#E80EB8", 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0,5.5))
axis(1, 1:5, names(media_finan_canal )[34:38], las = 2)
lines(1:5, media_finan_canal [2, 34:38], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:5, media_finan_canal [3, 34:38], col = '#19DBAD', type = "b", lwd = 2)
lines(1:5, media_finan_canal [4, 34:38], col = '#92F20F', type = "b", lwd = 2)
lines(1:5, media_finan_canal [5, 34:38], col = '#EBA81A', type = "b", lwd = 2)
lines(1:5, media_finan_canal [6, 34:38], col = '#8C7AF5', type = "b", lwd = 2)
grid()

legend("bottom", legend=c(paste("Grupo", 1:6, sep = '')),  col = c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')


plot(1:6, media_finan_canal [1, 39:44], type = 'b', col = "#E80EB8", 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0,1))
axis(1, 1:6, names(media_finan_canal )[39:44], las = 2)
lines(1:6, media_finan_canal [2, 39:44], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:6, media_finan_canal [3, 39:44], col = '#19DBAD', type = "b", lwd = 2)
lines(1:6, media_finan_canal [4, 39:44], col = '#92F20F', type = "b", lwd = 2)
lines(1:6, media_finan_canal [5, 39:44], col = '#EBA81A', type = "b", lwd = 2)
lines(1:6, media_finan_canal [6, 39:44], col = '#8C7AF5', type = "b", lwd = 2)
grid()
legend("topright", legend=c(paste("Grupo", 1:6, sep = '')),  col = c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')


plot(1:5, media_finan_canal [1, 45:49], type = 'b', col = "#E80EB8", 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', main = 'Grupos finales', ylim = c(0,5.5))
axis(1, 1:5, names(media_finan_canal )[45:49], las = 2)
lines(1:5, media_finan_canal [2, 45:49], col = '#0F1EF2', type = "b", lwd = 2)
lines(1:5, media_finan_canal [3, 45:49], col = '#19DBAD', type = "b", lwd = 2)
lines(1:5, media_finan_canal [4, 45:49], col = '#92F20F', type = "b", lwd = 2)
lines(1:5, media_finan_canal [5, 45:49], col = '#EBA81A', type = "b", lwd = 2)
lines(1:5, media_finan_canal [6, 45:49], col = '#8C7AF5', type = "b", lwd = 2)
grid()
legend("bottom", legend=c(paste("Grupo", 1:6, sep = '')),  col = c("#E80EB8", "#0F1EF2", "#19DBAD", "#92F20F", "#EBA81A", "#8C7AF5"), lty=1, lwd = 2,  bty = 'n')
```




* El grupo 1, 3 y 4 es el que tiene mayor nivel promedio de importaciones y exportaciones, mientras que el grupo 5 y 6 son los que menos realizan importaciones y exportaciones; el grupo 3 y 4 tienen mayor nivel promedio de cuentas por pagar y cobrar y mayor inventario, el grupo 1 y 2 tienen un nivel promedio de cuentas por pagar y cobrar e inventario intermedio mientras que el grupo 5 y 6 tienen un nivel promedio de cuentas por pagar y cobrar e inventario bajos.

* En general todos los grupos presentan mayor número promedio de ventas fisicas que electronicas, además el grupo 3 es el que presenta mayor promedio de pagos a personas naturales, mayor número promedio de ventas fisicas y electronicas y mayor número promedio de recaudos a personas juridicas y naturales. El grupo 1, 2 y 6 es el que realiza mayor proporción de pagos a personas juridicas, pero son los que realizan menor proporción de pagos a personas naturales. El grupo 2, 4, 6 tiene la menor cantidad de ventas fisicas y electronicas, además de los menores recaudos a personas juridicas y naturales. 

* El grupo 1 y 2, el grupo 3 y 4, el grupo 5 y 6 tiene comportamientos muy similares en las rotaciones de inventario, rotaciones de cuentas por cobrar y pagar y en los ciclos de negocio y financieros, en donde el grupo 5 y 6 es al que le toma menos tiempo promedio realizar estas rotaciones y ciclos, al grupo 1 y 2 le toma mayor tiempo promedio realizar las rotaciones de inventario y hacer los ciclos de negocio y financiero, por otro lado el grupo 4 es al que más tiempo promedio le toma realizar las rotaciones de cuenta por cobrar y pagar.

En general asi los grupos se parezcan entre si, estos se difieren en algo, ya sea en las variables financieras o en los canales.



### Conclusión general de los grupos formados


* Grupo 1: es de los que tiende a manejar mayores montos de dinero y mayor número de transacciones a través de los canales, además de que es uno de los grupos que mayores importaciones y exportaciones realiza, aunque igual el nivel de estas no es tan alto tiene buena cantidad de cuentas por cobrar, además de una gran cantidad de inventarios, que aunque no es la más alta, tiene un nivel promedio. Maneja un valor intermedio ventas fisicas en comparación con los demás grupos, se demora más rotando el inventario y realizando su ciclo de negocio y financiero, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas grandes, de productos, por ello manejan mucho inventario y se demoran mucho para rotarlo, además de que venden y compran productos al exterior.

* Grupo 2: es de los que tiende a manejar menores montos de dinero y menor número de transacciones a través de los canales, realizan pocas importaciones y exportaciones, tienen pocas cuentas por pagar y aunque tiene mas cuentas por cobrar, tampoco estas son altas, tiene un inventario de un nivel intermedio, es el grupo que tiene mayor porcentaje de pagos a personas juridicas que a personas naturales, además es uno de los grupos con menores ventas fisicas  y electronicas, es decir las menores ventas en general, además de ser el grupo que más se demora rotando el inventario y realizando el su ciclo de negocio y financiero, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que quizas no estan tan desarrolladas y estan en un proceso de crecimiento, en donde sus ventas no son las mejores y no tiene tanto contacto a nivel internacional.


* Grupo 3: es el que tiene mayores montos de dinero y mayor número de transacciones a través de los canales en comparación con el resto de los grupos, es uno de los grupos que mayores importaciones y exportaciones realiza, aunque igual el nivel de estas no es tan alto, tiene un nivel alto en la cuentas por pagar, cuentas por cobrar e inventario, además el grupo 3 es el que presenta mayor promedio de pagos a personas naturales, mayor número de ventas fisicas y electronicas y mayor número de recaudos a personas juridicas y naturales y en general tiene un nivel promedio en las rotaciones y ciclos, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas grandes muy desarrolladas, que se manejan a nivel nacional e internacional, que parecen ser de productos dado que manejan el mayor nivel de inventario, además de tiener muchas ventas ya sean fisicas o electronicas y sus rotaciones de inventario y de cuentas al igual que sus ciclos no tienden a ser tan rapidos ni tan lentos.

* Grupo 4: es de los que tiende a manejar menores montos de dinero y menor número de transacciones a través de los canales, es uno de los grupos que mayores importaciones y exportaciones realiza, aunque igual el nivel de estas no es tan alto, maneja un nivel muy alto de cuenta por cobrar y pagar, también dispone de un nivel alto de inventario, su nivel de ventas es intermedio al igual que la rotación de inventario y ciclo de negocio y financiero y en comparación con los otros grupos es el que tiene las rotaciones de cuentas por cobrar y pagar más lenta,  por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que ofrecen un servicio o producto en donde su forma de pago no es inmediata, como por ejemplo empresas que realizan pedidos o encargos, empresas distribuidores, etc.

* Grupo 5: es de los que tiende a manejar mayores montos de dinero y mayor número de transacciones a través de los canales, tiene un nivel bajo de importaciones y exportaciones y un nivel intermedio de cuentas por cobrar, cuentas por pagar e inventario, también tiene un alto porcentaje de pagos a personas juridicas y naturales, además un buen porcentaje de ventas fisicas y en general tiene rotaciones de inventario, rotaciones de cuentas y ciclos relativamente rápidos, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que se encargan de distribuir productos nacionales, los cuales tienen un proceso de venta rápido, dado que el inventario no es grande ni pequeño pero tienden a realizar rotaciones en poco tiempo y por el hecho de manejar buen monto de dinero nos da idea de que puede ser una empresa grande o muy bien acreditada.

* Grupo 6: es de los que tiende a manejar menores montos de dinero y menor número de transacciones a través de los canales, tiene niveles bajos de importaciones, exportaciones, de cuentas por cobrar y pagar e inventario, tiene porcentajes altos de pagos a personas juridicas y naturales y sus rotaciones de inventario, de cuentas y ciclos son rápidos, por lo tanto se piensa que los clientes que pertenecen a este grupo, son empresas que en general se espera que no sean grandes y tiendan a ofrecer servicios a nivel nacional.


<br>


Conclusión:

Mediante los grupos obtenidos con este segundo procedimiento de segmentación se puede notar una consistencia o una alta relación con los grupos formados en el anterior procedimiento, dado que cada uno de los grupos sigue teniendo relativamente las mismas caracteristicas a tanto en los canales como en las variables financieras, lo que implica que realizar el procedimiento en un respectivo orden no cambia mucho los grupos formados, dado que estos estan muy bien definidos.


Cabe resaltar que los dos subgrupos de los canales hallados a partir de los grupos ya conformados con las variables financieras, tienen la caracteristica de que uno tiende a manejar mayores montos de dinero y número de transacciones que el otro y este fenomeno se percibe en cada una de las subagrupaciones realizadas, lo cual da idea del porque hay consistencia con el procedimiento 1  y procedimiento 2 de segmentación, en el cual el procedimiento 1 realiza primero la segmentación por las variables de los canales y claramente se resaltan dos grupos los cuales se diferencian por los montos de dinero que manejan y número de transacciones, por lo tanto a pesar de que se realice primero la agrupación por las variables financieras y los tres grupos tengan sus diferencias, en todos se conserva el comportamiento descrito en la primera segmentación para las variables de los canales.


A pesar de que existe una alta relación entre los dos procedimientos de segmentación realizados, mediante los análisis se concluye que estan mejor definidos los grupos realizados mediante el procedimiento 2 (primero financieras y luego canales), debido a que el orden lógico por el cual se caracterizaría un nuevo usuario (que no tiene información de uso de los canales de la empresa) sería mediante la recolección de la información financiera del nuevo cliente. Además de que los grupos finales que se forman tienen unas características que se acomodan mas a interpretaciones de perfiles de empresas reales y por lo tanto las interpretaciones tienen más coherencia.

Por lo tanto se quiere realizar un procedimiento adicional que sigue la misma estructura del procedimiento 2 donde se realiza primero la segmentación por las variables financieras y luego por las variables de los canales,considerando una simplificación de las variables, ya que se decide realizar una transformación o manipulación de variables las cuales permiten reducir el número de estas teniendo en cuenta la relación que existe entre los montos de dinero y número de transacciones realizados por cada uno de los clientes.


## Procedimiento 3

 Para las variables de los canales se tienen 4 tipos de variables, que se definen de la siguiente manera:
 
  - en_vm_canalX: valor del ticket promedio anual de entrada por el canal X
  - sal_vm_canalX: valor del ticket promedio anual de salida por el canal X
  - en_tx_canalX: cantidad de transacciones de entrada mensuales en promedio por el canal X
  - sal_tx_canalX: cantidad de transacciones de salida mensuales en promedio por el canal X

Se realiza el proceso de reducción de variables de los canales con los siguientes criterios:

 1. Primero se deben llevar todos los canales a una forma similar, es decir, las variables que son de tipo en_tx_canalX y sal_tx_canalX, estan en valores mensuales, por lo tanto se deben multiplicar por 12 para que esten en promedios anuales, así como lo están las variables en_vm_canalX y sal_vm_canalX. 
 
 2. Se obtiene la cantidad de dinero de entrada promedio anual en cada empresa, para eso se multiplican las variables que son de tipo en_vm_canalX por en_tx_canalX.
 
 3. Se obtiene la cantidad de dinero de salida promedio anual en cada empresa, para eso se multiplican las variables que son de tipo sal_vm_canalX por sal_tx_canalX.

Por lo tanto, las variables resultantes indican el dinero promedio anual de cada uno de los clientes en los diferentes canales.

```{r}
df <- read.csv("base_trabajo_segmentacion.csv", sep = ";", dec = '.', header = T)
df <- df[, -1]

montos_entrada <- df[,1:11] # Variables en_vm_canalX
transacciones_entrada <- df[,12:22] #  Variables en_tx_canalX
montos_salida <- df[,23:26] # Variables sal_vm_canalX
transacciones_salida <- df[,27:30] # Variables sal_tx_canalX


monto_promedio_anual_entrada <- montos_entrada*(transacciones_entrada*12)
monto_promedio_anual_salida <- montos_salida*(transacciones_salida*12)

df <- cbind(monto_promedio_anual_entrada, monto_promedio_anual_salida, finan_no_scaled)

colnames(df)[1:15] <- c("entrada_canal1","entrada_canal2","entrada_canal3","entrada_canal4",
"entrada_canal5","entrada_canal6","entrada_canal7","entrada_canal8",
"entrada_canal9","entrada_canal10","entrada_otros", "salida_canal5",
"salida_canal2","salida_canal8","salida_otros")

head(df)
```


* Separación de las variables financieras y canales (no escaladas)

```{r}
Canal_no_scaled <- df[ ,1:15]
finan_no_scaled <- df[, 16:31]
```


* Escalamiento de los datos completos

```{r}
df_scaled <- scale(df, center = T, scale = T)
```


* Separando en conjunto de datos de canales y financiera donde ya estan escaladas:

```{r}
Canal_scaled <- df_scaled[,1:15]
finan_scaled <- df_scaled[,16:31]
```

* Sacando logaritmo a los canales y escalando
 
```{r}
Canal_log <- log(Canal_no_scaled + 1) 

Canal_log_scaled <- scale(log(Canal_no_scaled + 1), center = T, scale = T)
```


Análisis descriptivo de los canales


```{r}
plot(1:15, colMeans(Canal_log), type = 'b', col = '#038EC3', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'Media', main = 'Logaritmo del dinero que se maneja anualmente por cada canal')
axis(1, 1:15, names(df)[1:15], las = 2)
grid()
```

Del gráfico anterior se observa que:
 
 - El canal 2 es el que en promedio maneja mayor cantidad de dinero de entrada y salida.
 
 - Los canales 1 y 2 son los que en promedio manejan mayor cantidad de dinero de entrada.
 
 - Los canales que manejan en promedio una cantidad intermedia de dinero de entrada son los canales 3, 5, 6, 8 y 9.
 
 - Los canales 7, 10 y otros son los que en promedio tienen menores ingresos de dinero.
 
 - Los canales 8 y otros de salida son los que en promedio tiene menor cantidad de dinero.

 - El canal 5 tanto en entrada como salida maneja una cantidad de dinero similar.





Ya que el procedimiento 3 es una modificación del procedimiento 2 en la parte de segmentación que se realizó con las variables de canales, entonces la segmentación que involucra las variables financieras sigue siendo exactamente igual.


```{r}
par(mfrow=c(1,3))
plot(centroid1[1:5, 1], type = 'b', col = 'red', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim=c(0, 5.5))
axis(1, 1:5, row.names(centroid1)[1:5], las = 2)
lines(centroid1[1:5, 2], col = 'purple', type = "b", lwd = 2)
lines(centroid1[1:5, 3], col = "blue", type = "b", lwd = 2)


legend("bottomright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c("red", "purple", "blue"), lty=1, bty = 'n')


plot(centroid1[6:11, 1], type = 'b', col = 'red', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim=c(0,1))
axis(1, 1:6, row.names(centroid1)[6:11], las = 2)
lines(centroid1[6:11, 2], col = 'purple', type = "b", lwd = 2)
lines(centroid1[6:11, 3], col = "blue", type = "b", lwd = 2)


legend("topright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c("red", "purple", "blue"), lty=1, bty = 'n')

plot(centroid1[12:16, 1], type = 'b', col = 'red', 
     xaxt = "n", xlab = '', lwd = 2, ylab = 'centroide', ylim=c(0, 5.5))
axis(1, 1:5, row.names(centroid1)[12:16], las = 2)
lines(centroid1[12:16, 2], col = 'purple', type = "b", lwd = 2)
lines(centroid1[12:16, 3], col = "blue", type = "b", lwd = 2)


legend("bottomright", legend=c("Grupo1","Grupo2", "Grupo3"),
       col=c("red", "purple", "blue"), lty=1, bty = 'n')
```

De la gráfica anterior se muestra los grupos obtenidos con la segmentación en las variables financieras. Su análisis se puede observar en el procedimiento 2 (boton atajis devuelvis de las conclusiones)































