---
title: 'Intento # 2'
author: "Miguel Ángel Londoño Ciceros"
date: "27/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

* Lectura de la base de datos

```{r}
df <- read.csv("base_trabajo_segmentacion.csv", sep = ";", dec = '.', header = T)

head(df)
```


* Nombres de las variables de los datos originales

```{r}
df <- df[, -1]
colnames(df)
```

* Análisis descriptivo de las variables financieras

```{r}
finan_no_scaled <- df[, 31:46]
Canal_no_scaled <- df[ , 1:30]
```

```{r}
dim(finan_no_scaled)[2]
```


```{r}
library(ggplot2)
for(i in 1:dim(finan_no_scaled)[2]){
  
  if(class(finan_no_scaled[, i])=="integer"){
    p <- ggplot(finan_no_scaled, aes(x = finan_no_scaled[, i], y = ..prop..))+ geom_bar(fill = "#0c4c8a")
  }else{
    p <- ggplot(finan_no_scaled, aes(x=finan_no_scaled[, i])) +  geom_histogram(bins = 10, fill = "#0c4c8a")
  }
  
  p_final <- p +
    labs(x = colnames(finan_no_scaled)[i]) +
    theme_gray() 
    
  
  print(p_final)
}


```

Interpretaciones de las varibles solas:

 * La mayoría de las empresas presentan un nivel bajo de exportaciones

Interpretaciones comparandolas con los grupos:

```{r}
pairs(finan_no_scaled[,c(1,2,3,4,5,6,7,13,15,16)])
```



### Matriz de correlaciones

```{r}
library(corrplot)
corrplot(cor(finan_no_scaled), 
         method="color",  
         type="upper", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         sig.level = 0.01, insig = "blank", 
         number.cex = 0.6,
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
         )
```


Correlaciones entre las variables 



Análisis descriptivo de los canales

```{r}
pairs(Canal_no_scaled)
```

```{r}
library(corrplot)
corrplot(cor(Canal_no_scaled), 
         method="color",  
         type="upper", order='original', 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         sig.level = 0.01, insig = "blank", 
         number.cex = 0.5,
         # hide correlation coefficient on the principal diagonal
         diag=FALSE
         )
```


* Escalamiento de los datos completos

```{r}
df_scaled <- scale(df, center = T, scale = T)
```


* Separando en conjunto de datos de canales y financiera donde ya estan escaladas:

```{r}
canales <- df_scaled[,1:30]
financiera <- df_scaled[,31:46]
```


* Se utiliza agrupamiento jerarquico con la idea de que nos diga la cantidad de grupos que se deben considerar 

```{r}
library(ggdendro)
library(ggplot2)
require(factoextra)

dendrogram <- hclust(dist(financiera, method = 'euclidean'), method = 'ward.D')


plot(dendrogram, xlab="", sub="", cex=0.9)
rect.hclust(dendrogram, k=3, border="cyan4")
```


* Agrupamiento k means con las variables financieras:

```{r}
require(cluster)

set.seed(93284)
kc <- kmeans(financiera, 3 , nstart = 5, iter.max = 100)

clusplot(financiera, kc$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.p = kc$cluster )
```

* Creación de un conjunto de datos con las variables financieras y la variable grupo 

```{r}
grupos <- as.factor(kc$cluster)

fina_group <- data.frame(grupos, finan_no_scaled)
head(fina_group)
```

* Niveles de la variable grupo

```{r}
levels(fina_group$grupos)
```

* Gráficos de barras que nos permitiran sacar carateristicas de cada uno de los grupos

```{r}
library(ggplot2)
for(i in 2:dim(fina_group)[2]){
  
  if(class(fina_group[, i])=="integer"){
    p <- ggplot(fina_group, aes(x = fina_group[, i], y = ..prop..))+ geom_bar(fill = "#0c4c8a")+facet_grid(vars(), vars(grupos))
  }else{
    p <- ggplot(fina_group, aes(x = factor(fina_group$grupo), y=fina_group[, i])) +  geom_boxplot()
  }
  
  p_final <- p +
    labs(x = colnames(fina_group)[i]) +
    theme_gray() 
    
  
  print(p_final)
}

```


```{r}
library(ggplot2)
for(i in 2:dim(fina_group)[2]){
  
  if(class(fina_group[, i])=="integer"){
    p <- ggplot(fina_group, aes(x = fina_group[, i], y = ..prop..))+ geom_bar(fill = "#0c4c8a")
  }else{
    p <- ggplot(fina_group, aes(x = fina_group[, i])) +  geom_histogram(bins = 10)
  }
  
  p_final <- p +
    labs(x = colnames(fina_group)[i]) +
    theme_gray() + 
    facet_grid(vars(), vars(grupos))
  
  print(p_final)
}
```


```{r}
par(mfrow=c(1,2))
boxplot(fina_group$pagos_pj~fina_group$grupos)
boxplot(fina_group$pagos_pn~fina_group$grupos)
```



```{r}
df_scaled_group <- data.frame(grupos,df_scaled)
outliers <- c(825, 1416, 1462, 1668, 1773)
df_scaled_group <- df_scaled_group[-outliers,]
```


```{r}
grupo1 <- df_scaled_group[df_scaled_group$grupos==1,]
grupo2 <- df_scaled_group[df_scaled_group$grupos==2,]
grupo3 <- df_scaled_group[df_scaled_group$grupos==3,]
```

```{r}
require(cluster)

set.seed(93284)
kc1 <- kmeans(grupo1[,2:31], 1 , nstart = 5, iter.max = 100)

clusplot(grupo1[,2:31], kc1$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.p = kc1$cluster )
```

```{r}
require(cluster)

set.seed(93284)
kc2 <- kmeans(grupo2[,2:31], 2, nstart = 5, iter.max = 100)

clusplot(grupo2[,2:31], kc2$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.p = kc2$cluster )
```

```{r}
require(cluster)

set.seed(93284)
kc3 <- kmeans(grupo3[-19,2:31], 1 , nstart = 5, iter.max = 100)

clusplot(grupo3[-19,2:31], kc3$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.p = kc3$cluster )
```

```{r}
which(kc3$cluster == 1)
```

```{r}
kc3$cluster
```


## 2 Grupos
 
```{r}
require(cluster)

set.seed(93284)
kc <- kmeans(financiera, 2 , nstart = 5, iter.max = 100)

clusplot(financiera, kc$cluster, color = TRUE, 
          shade = FALSE, labels = 4, lines = 1,
          col.p = kc$cluster )
```

```{r}
fina_group <- df[, 31:46]

grupos <- as.factor(kc$cluster)

fina_group <- data.frame(grupos, fina_group)
```

```{r}
levels(fina_group$grupos)
```

```{r}
for(i in 2:dim(fina_group)[2]){
  
  p <- ggplot(fina_group, aes(x = fina_group[, i],y = ..prop..)) +
    geom_bar(fill = "#0c4c8a") +
    labs(x = colnames(fina_group)[i]) +
    theme_gray() +
    facet_grid(vars(), vars(grupos))
  
  print(p)
}

```



```{r}
apply(df[kc$cluster == 1, 31:46], 2, function(x) barplot(table(x)))
```

```{r}
apply(df[kc$cluster == 2, 31:46], 2, function(x) barplot(table(x)))
```

```{r}
apply(df[kc$cluster == 3, 31:46], 2, function(x) barplot(table(x)))
```

* Media de los grupos
```{r}
aggregate(.~grupos,data=fina_group, FUN=mean)
```
* Varianza de cada grupo
```{r}
aggregate(.~grupos,data=fina_group, FUN=var)
```
```{r}
aggregate(.~grupos,data=fina_group, FUN=median)
```
